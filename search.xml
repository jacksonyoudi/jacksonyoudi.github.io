<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>(效率工具)程序员必备终端及美化</title>
    <url>/2021/07/31/iterm/</url>
    <content><![CDATA[<p><img src="https://raw.githubusercontent.com/jacksonyoudi/images/main/uPic/QicdYL.jpg"></p>
<p>作为一个合格的程序员，CLI是必备的技能。 工欲善其事，必先利其器。一个顺手并且提高效率的终端是必须的。 平时很多人会私信或评论中问我关于我的终端相关的内容，今天我整理出来。分享给大家。</p>
<h4 id="需要安装的软件"><a href="#需要安装的软件" class="headerlink" title="需要安装的软件"></a>需要安装的软件</h4><blockquote>
<ol>
<li>iterm2</li>
<li>dracula</li>
<li>zsh</li>
<li>Oh My ZSH</li>
<li>powerlevel10k</li>
</ol>
</blockquote>
<p>上面👆给出了需要安装的软件包， 下面就按安装的顺序一个一个介绍</p>
<h3 id="一、iterm2"><a href="#一、iterm2" class="headerlink" title="一、iterm2"></a>一、iterm2</h3><p><img src="https://raw.githubusercontent.com/jacksonyoudi/images/main/uPic/Wbh9jA.jpg"></p>
<p>这个就不多介绍， 我相信只要是使用mac的程序员，这个都是知道的， 当然，也有一个其他类似的产品。 后面安装的和iterm2没有强依赖。 这只是一个终端， 没有最好，适合你的就是最好的。 顺便提一下， 我自己的💻使用touch bar的， 是支持touch bar，一些很炫的操作可以在touch bar上操作。但是，我一直使用公司的笔记本，使用快捷键进行操作， 效率更高。</p>
<p><a href="https://www.iterm2.com/">官网</a></p>
<h4 id="1-安装"><a href="#1-安装" class="headerlink" title="1. 安装"></a>1. 安装</h4><p>1). 方式一<br><a href="https://www.iterm2.com/downloads.html">下载地址</a>， 下载后，点击安装就可以了</p>
<p>2). 方式二</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">brew cask <span class="token function">install</span> iterm2   <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>brew使用，这里就不介绍了</p>
<h4 id="2-使用"><a href="#2-使用" class="headerlink" title="2. 使用"></a>2. 使用</h4><p><a href="https://www.iterm2.com/documentation.html">文档</a><br>这里顺便介绍一下，主要是快捷键, 自己对着文档，学习一下， 因为重点不在这。<br><code>CMD + 单击</code> 可以实现跳转</p>
<h3 id="二、-安装配置dracula主题"><a href="#二、-安装配置dracula主题" class="headerlink" title="二、 安装配置dracula主题"></a>二、 安装配置dracula主题</h3><p>这个也有两种方式</p>
<ol>
<li>使用git<br><code>git clone https://github.com/dracula/iterm.git</code></li>
<li>直接下载，解压<br>下载地址 <a href="https://github.com/dracula/iterm/archive/master.zip">GitHub .zip download</a></li>
</ol>
<p><em>使用主题</em><br>配置过程如下</p>
<blockquote>
<ol>
<li>打开 iTerm2 &gt; Preferences &gt; Profiles &gt; Colors Tab， 选择color</li>
<li>点击下面的<code>Color Presets</code>,展开</li>
<li>选择<code>import</code>, 将上面👆下载的文件导入</li>
<li>选择<code>Dracula.itermcolors</code>文件导入</li>
<li>导入以后，重新选择 <code>Color Presets</code>，选择 <code>dracula</code>就可以了<br> 具体如下：<br> <img src="https://raw.githubusercontent.com/jacksonyoudi/images/main/uPic/FLOTC9.jpg"></li>
</ol>
</blockquote>
<h3 id="三、Oh-My-ZSH"><a href="#三、Oh-My-ZSH" class="headerlink" title="三、Oh My ZSH"></a>三、Oh My ZSH</h3><p><a href="%5Bhttps://ohmyz.sh/%5D(https://ohmyz.sh/)">Oh My ZSH</a><br><img src="https://raw.githubusercontent.com/jacksonyoudi/images/main/uPic/1zZOJy.jpg"></p>
<ol>
<li><p>先安装 zsh<br>下面只给命令</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">
<span class="token comment"># 安装</span>
brew <span class="token function">install</span> <span class="token function">zsh</span> zsh-completions

<span class="token comment"># 切换shell</span>
chsh -s /bin/zsh<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
<li><p>安装Oh My ZSH<br>下面选一种</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sh</span> -c <span class="token string">"<span class="token variable"><span class="token variable">$(</span><span class="token function">curl</span> -fsSL https://raw.github.com/robbyrussell/oh-my-zsh/master/tools/install.sh<span class="token variable">)</span></span>"</span>
<span class="token comment"># or</span>
<span class="token function">sh</span> -c <span class="token string">"<span class="token variable"><span class="token variable">$(</span><span class="token function">wget</span> https://raw.github.com/robbyrussell/oh-my-zsh/master/tools/install.sh -O -<span class="token variable">)</span></span>"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>如果感兴趣，可以看下脚本内容，定义了安装目录什么的，和常见的安装shell没有区别。</p>
</li>
<li><p>关闭iterm2, 然后再打开，就生效了</p>
</li>
<li><p>配置 一个插件<br>配置在 <code>.zshrc</code>文件中，配置很简单<br>可以使用的插件以及描述 <a href="https://github.com/robbyrussell/oh-my-zsh/tree/master/plugins">github</a></p>
</li>
</ol>
<h3 id="四、powerlevel10k"><a href="#四、powerlevel10k" class="headerlink" title="四、powerlevel10k"></a>四、powerlevel10k</h3><p><a href="https://github.com/romkatv/powerlevel10k">github地址</a></p>
<p><img src="https://raw.githubusercontent.com/jacksonyoudi/images/main/uPic/DUuyUe.jpg"></p>
<ol>
<li>安装主题<br>也有很多种方式， 这里使用git<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">git</span> clone --depth<span class="token operator">=</span><span class="token number">1</span> https://github.com/romkatv/powerlevel10k.git <span class="token variable">${ZSH_CUSTOM<span class="token operator">:-</span>$HOME<span class="token operator">/</span>.oh-my-zsh<span class="token operator">/</span>custom}</span>/themes/powerlevel10k<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
在 <code>.zshrc</code>中配置主题生效，退出， 就可以生效<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token assign-left variable">ZSH_THEME</span><span class="token operator">=</span><span class="token string">"powerlevel10k/powerlevel10k"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
如果你还没有安装字体，那么可以使用下面的命令来安装所需字体。<br>一些需要字体安装的文档 <a href="https://github.com/bhilburn/powerlevel9k/wiki/Install-Instructions#step-2-install-a-powerline-font">install-a-powerline-font</a><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># clone</span>
<span class="token function">git</span> clone https://github.com/powerline/fonts.git
<span class="token comment"># install</span>
<span class="token builtin class-name">cd</span> fonts
./install.sh
<span class="token comment"># clean-up a bit</span>
<span class="token builtin class-name">cd</span> <span class="token punctuation">..</span>
<span class="token function">rm</span> -rf fonts<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ol>
<p>字体安装完毕之后，打开 Shell 你会发现字体依然没有生效，这是因为你没有选择对应的字体。在设置中选择你想要的支持字体。<br>如果有一些特殊的图标不能正常显示， 可能需要安装 <a href="https://github.com/gabrielelana/awesome-terminal-fonts">awesome-terminal-fonts</a>字体</p>
<p>还有一些图标，比如github,gitlab, git,linux的一些图标在<code>/Users/youdi/.oh-my-zsh/custom/themes/powerlevel9k/functions/icons.zsh</code>中修改。</p>
<p><img src="https://raw.githubusercontent.com/jacksonyoudi/images/main/uPic/Mob8Xk.jpg"></p>
<h4 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h4><p>我使用 <code>colorls</code>,是ruby的的工具,<br><a href="%5Bhttps://github.com/athityakumar/colorls%5D(https://github.com/athityakumar/colorls)">安装</a><br><img src="https://raw.githubusercontent.com/jacksonyoudi/images/main/uPic/vjJGRU.jpg"></p>
<p>另外一个查看性能的工具 <code>gotop</code>, 你肯定用过 <code>top</code>,<code>htop</code><br><img src="https://raw.githubusercontent.com/jacksonyoudi/images/main/uPic/8cEKLj.jpg"></p>
<p><a href="%5Bhttps://github.com/cjbassi/gotop%5D(https://github.com/cjbassi/gotop)">源码</a>, 类似的 top的工具很多，各个语言版本的都有， 我比较喜欢编译型语言的版本。</p>
]]></content>
      <categories>
        <category>工具</category>
      </categories>
      <tags>
        <tag>mac</tag>
        <tag>zsh</tag>
        <tag>powerlevel10k</tag>
        <tag>dracula</tag>
      </tags>
  </entry>
  <entry>
    <title>爬虫的&quot;盗亦有道&quot;-Robots协议</title>
    <url>/2021/07/31/robots-protocol/</url>
    <content><![CDATA[<h2 id="网络爬虫的君子协议"><a href="#网络爬虫的君子协议" class="headerlink" title="网络爬虫的君子协议"></a>网络爬虫的君子协议</h2><p><img src="https://raw.githubusercontent.com/jacksonyoudi/images/main/uPic/3tqLVS.jpg"></p>
<h3 id="网络爬虫的尺寸"><a href="#网络爬虫的尺寸" class="headerlink" title="网络爬虫的尺寸"></a>网络爬虫的尺寸</h3><table>
<thead>
<tr>
<th>小规模，数量小，爬去速度不敏感，requests库</th>
<th>中规模，数据规模较大，爬取速度敏感scrapy库</th>
<th>大规模，搜索引擎,爬取速度关键定制开发</th>
</tr>
</thead>
<tbody><tr>
<td>爬取网页 玩转网页</td>
<td>爬取网站 爬取系列网站</td>
<td>爬取全网</td>
</tr>
</tbody></table>
<h3 id="网络爬虫引发的问题"><a href="#网络爬虫引发的问题" class="headerlink" title="网络爬虫引发的问题"></a>网络爬虫引发的问题</h3><ul>
<li>性能骚扰</li>
<li>法律风险</li>
<li>隐私泄露</li>
</ul>
<p><em>网络爬虫的”性能骚扰”</em><br>web服务器默认接受人类访问，受限于编写水平和目的，网络爬虫将会为web服务器带来巨大的资源的开销。<br><em>网络爬虫的法律风险</em><br>服务器上的数据有产权归属，网络爬虫获取数据后牟利将会带来法律的风险。<br><em>网络爬虫的隐私泄露</em><br>网络爬虫可能具备突破简单访问的控制能力，获取被保护的数据，从而泄露个人隐私。</p>
<h3 id="网络爬虫的限制"><a href="#网络爬虫的限制" class="headerlink" title="网络爬虫的限制"></a>网络爬虫的限制</h3><ul>
<li>来源审查：判断<code>User-Agent</code>进行限制，检查来访者HTTP协议头的User-Agent域，只响应浏览器或友好爬虫的访问</li>
<li>发布公告： <code>Robots</code>协议， 告知所有的爬虫网站的爬虫策略，要求爬虫遵守。</li>
</ul>
<h2 id="Robots协议"><a href="#Robots协议" class="headerlink" title="Robots协议"></a>Robots协议</h2><blockquote>
<p>Robots协议（也称为爬虫协议、机器人协议等）的全称是“网络爬虫排除标准”（Robots ExclusionProtocol），网站通过Robots协议告诉搜索引擎哪些页面可以抓取，哪些页面不能抓取.</p>
</blockquote>
<p>根据协议，网站管理员可以在网站域名的根目录下放一个robots.txt 文本文件，里面可以指定不同的网络爬虫能访问的页面和禁止访问的页面，指定的页面由正则表达式表示。网络爬虫在采集这个网站之前，首先获取到这个文件，然后解析到其中的规则，然后根据规则来采集网站的数据。</p>
<p>注意，这个协议的存在更多的是需要网络爬虫去遵守，而起不到防止爬虫的功能。</p>
<h3 id="为什么需要Robots协议"><a href="#为什么需要Robots协议" class="headerlink" title="为什么需要Robots协议"></a>为什么需要Robots协议</h3><p>互联网上的网页是通过超级链接互相关联起来的，从而形成了网页的网状结构。爬虫的工作方式就像蜘蛛在网上沿着链接爬来爬去，最基本的流程可以简化如下：</p>
<ol>
<li>喂给爬虫一堆url，我们称之为种子(seeds)；</li>
<li>爬虫抓取seeds，解析html网页，抽取其中的超级链接；</li>
<li>爬虫接着抓取这些新发现的链接指向的网页。</li>
</ol>
<p>步骤2和步骤3循环往复。</p>
<p>了解了上面的流程就能发现：对爬虫来说网站非常被动，只有老老实实被抓取的份。</p>
<p>所以，对于网站的管理者来说，就存在这样的需求：</p>
<p>某些路径下是个人隐私或者网站管理使用，不想被搜索引擎抓取，比如说日本爱情动作片；<br>不喜欢某个搜索引擎，不愿意被他抓取，最有名的就是之前淘宝不希望被百度抓取；<br>小网站使用的是公用的虚拟主机，流量有限或者需要付费，希望搜索引擎抓的温柔点；<br>某些网页是动态生成的，没有直接的链接指向，但是希望内容被搜索引擎抓取和索引。</p>
<p>网站内容的所有者是网站管理员，搜索引擎应该尊重所有者的意愿，为了满足以上等等，就需要提供一种网站和爬虫进行沟通的途径，给网站管理员表达自己意愿的机会。有需求就有供应，robots协议就此诞生。</p>
<h4 id="案例"><a href="#案例" class="headerlink" title="案例"></a>案例</h4><p>京东的Robots协议<br><code>https://www.jd.com/robots.txt</code></p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">User<span class="token operator">-</span>agent<span class="token operator">:</span> <span class="token operator">*</span> 
Disallow<span class="token operator">:</span> <span class="token operator">/</span><span class="token operator">?</span><span class="token operator">*</span> 
Disallow<span class="token operator">:</span> <span class="token operator">/</span>pop<span class="token comment">/*.html 
Disallow: /pinpai/*.html?* 
User-agent: EtaoSpider 
Disallow: / 
User-agent: HuihuiSpider 
Disallow: / 
User-agent: GwdangSpider 
Disallow: / 
User-agent: WochachaSpider 
Disallow: /</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>百度的Robots协议<br><code>https://www.baidu.com/robots.txt</code></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">User-agent: Baiduspider
Disallow: /baidu
Disallow: /s?
Disallow: /ulink?
Disallow: /link?

User-agent: Googlebot
Disallow: /baidu
Disallow: /s?
Disallow: /shifen/
Disallow: /homepage/
Disallow: /cpro
Disallow: /ulink?
Disallow: /link?

User-agent: MSNBot
Disallow: /baidu
Disallow: /s?
Disallow: /shifen/
Disallow: /homepage/
Disallow: /cpro
Disallow: /ulink?
Disallow: /link?

User-agent: Baiduspider-image
Disallow: /baidu
Disallow: /s?
Disallow: /shifen/
Disallow: /homepage/
Disallow: /cpro
Disallow: /ulink?
Disallow: /link?

User-agent: YoudaoBot
Disallow: /baidu
Disallow: /s?
Disallow: /shifen/
Disallow: /homepage/
Disallow: /cpro
Disallow: /ulink?
Disallow: /link?

User-agent: Sogou web spider
Disallow: /baidu
Disallow: /s?
Disallow: /shifen/
Disallow: /homepage/
Disallow: /cpro
Disallow: /ulink?
Disallow: /link?

User-agent: Sogou inst spider
Disallow: /baidu
Disallow: /s?
Disallow: /shifen/
Disallow: /homepage/
Disallow: /cpro
Disallow: /ulink?
Disallow: /link?

User-agent: Sogou spider2
Disallow: /baidu
Disallow: /s?
Disallow: /shifen/
Disallow: /homepage/
Disallow: /cpro
Disallow: /ulink?
Disallow: /link?

User-agent: Sogou blog
Disallow: /baidu
Disallow: /s?
Disallow: /shifen/
Disallow: /homepage/
Disallow: /cpro
Disallow: /ulink?
Disallow: /link?

User-agent: Sogou News Spider
Disallow: /baidu
Disallow: /s?
Disallow: /shifen/
Disallow: /homepage/
Disallow: /cpro
Disallow: /ulink?
Disallow: /link?

User-agent: Sogou Orion spider
Disallow: /baidu
Disallow: /s?
Disallow: /shifen/
Disallow: /homepage/
Disallow: /cpro
Disallow: /ulink?
Disallow: /link?

User-agent: ChinasoSpider
Disallow: /baidu
Disallow: /s?
Disallow: /shifen/
Disallow: /homepage/
Disallow: /cpro
Disallow: /ulink?
Disallow: /link?

User-agent: Sosospider
Disallow: /baidu
Disallow: /s?
Disallow: /shifen/
Disallow: /homepage/
Disallow: /cpro
Disallow: /ulink?
Disallow: /link?


User-agent: yisouspider
Disallow: /baidu
Disallow: /s?
Disallow: /shifen/
Disallow: /homepage/
Disallow: /cpro
Disallow: /ulink?
Disallow: /link?

User-agent: EasouSpider
Disallow: /baidu
Disallow: /s?
Disallow: /shifen/
Disallow: /homepage/
Disallow: /cpro
Disallow: /ulink?
Disallow: /link?

User-agent: *
Disallow: /<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>上面，<code>*</code>代表所有，<code>/</code>代表根目录</p>
<h3 id="Robots协议的写法"><a href="#Robots协议的写法" class="headerlink" title="Robots协议的写法"></a>Robots协议的写法</h3><p>既然网络爬虫在爬取一个网站之前，要先获取到这个文件，然后解析到其中的规则，那么，Robots就必须要有一套通用的语法规则。</p>
<p>最简单的robots.txt只有两条规则：</p>
<p>User-agent：指定对哪些爬虫生效<br>Disallow：指定要屏蔽的网址<br>先说User-agent，爬虫抓取时会声明自己的身份，这就是User-agent，没错，就是http协议里的User-agent。robots.txt利用User-agent来区分各个引擎的爬虫，比如说google网页搜索爬虫的User-agent为Googlebot。</p>
<p>可能有读者要问了，我怎么知道爬虫的User-agent是什么?你还可以查相关搜索引擎的资料得到官方的数据，比如说百度的爬虫列表是这样的：</p>
<table>
<thead>
<tr>
<th>产品名称</th>
<th>对应User-Agent</th>
</tr>
</thead>
<tbody><tr>
<td>网页搜索</td>
<td>Baiduspider</td>
</tr>
<tr>
<td>移动搜索</td>
<td>Baiduspider</td>
</tr>
<tr>
<td>图片搜索</td>
<td>Baiduspider-image</td>
</tr>
<tr>
<td>视频搜索</td>
<td>Baiduspider-video</td>
</tr>
<tr>
<td>新闻搜索</td>
<td>Baiduspider-news</td>
</tr>
<tr>
<td>百度搜索</td>
<td>Baiduspider-favo</td>
</tr>
<tr>
<td>百度联盟</td>
<td>Baiduspider-cpro</td>
</tr>
<tr>
<td>商务搜索</td>
<td>Baiduspider-ads</td>
</tr>
</tbody></table>
<p>Disallow 行列出的是要拦截的网页，以正斜线 (/) 开头，可以列出特定的网址或模式。要屏蔽整个网站，使用正斜线即可;要屏蔽某一目录以及其中的所有内容，在目录名后添加正斜线;要屏蔽某个具体的网页，就指出这个网页。</p>
<p>下面介绍一些实例:<br>允许所有的robot访问</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">User-agent: *
Disallow:<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>或者也可以建一个空文件 “/robots.txt” file。</p>
<p>禁止爬虫访问所有目录</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">User-agent: *
Disallow: /<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>禁止爬虫访问某些目录</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">User-agent: *
Disallow: /a/
Disallow: /b/
Disallow: /c/<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>禁止某些爬虫访问</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">User-agent: BadBot
Disallow: /<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>只允许某个爬虫访问</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">User-agent: MangCrawler
Disallow:
User-agent: *
Disallow: /<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们再来结合两个真实的范例来学习一下。先看这个例子：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">User-agent: Baiduspider
Disallow: /
User-agent: baiduspider
Disallow: /<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个是淘宝网的Robots协议内容，相信你已经看出来了，淘宝网禁止百度的爬虫访问。</p>
<p>再来看一个例子：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">User-agent: *
Disallow: /?*
Disallow: /pop/*.html
User-agent: EtaoSpider
Disallow: /<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个稍微复杂点，京东有2个目录不希望所有的爬虫来抓。同时，京东完全屏蔽了一淘网的蜘蛛（EtaoSpider是一淘网的蜘蛛）。</p>
<h2 id="Robots协议进阶知识"><a href="#Robots协议进阶知识" class="headerlink" title="Robots协议进阶知识"></a>Robots协议进阶知识</h2><p><strong>sitemap</strong><br>爬虫会通过网页内部的链接发现新的网页。但是如果没有连接指向的网页怎么办?或者用户输入条件生成的动态网页怎么办?能否让网站管理员通知搜索引擎他们网站上有哪些可供抓取的网页?这就是sitemap，最简单的 Sitepmap 形式就是 XML 文件，在其中列出网站中的网址以及关于每个网址的其他数据(上次更新的时间、更改的频率以及相对于网站上其他网址的重要程度等等)，利用这些信息搜索引擎可以更加智能地抓取网站内容。</p>
<p>新的问题来了，爬虫怎么知道这个网站有没有提供sitemap文件，或者说网站管理员生成了sitemap，(可能是多个文件)，爬虫怎么知道放在哪里呢?</p>
<p>由于robots.txt的位置是固定的，于是大家就想到了把sitemap的位置信息放在robots.txt里。这就成为robots.txt里的新成员了。</p>
<p>节选一段google robots.txt：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">Sitemap: http://www.gstatic.com/cultur<span class="token punctuation">..</span>.
Sitemap: http://www.google.com/hostedn<span class="token punctuation">..</span>.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>插一句，考虑到一个网站的网页众多，sitemap人工维护不太靠谱，google提供了工具可以自动生成sitemap。</p>
<p><strong>meta tag</strong><br>其实严格来说这部分内容不属于robots.txt。</p>
<p>robots.txt的初衷是为了让网站管理员管理可以出现在搜索引擎里的网站内容。但是，即使使用 robots.txt 文件让爬虫无法抓取这些内容，搜索引擎也可以通过其他方式找到这些网页并将它添加到索引中。例如，其他网站仍可能链接到该网站。因此，网页网址及其他公开的信息(如指向相关网站的链接中的定位文字或开放式目录管理系统中的标题)有可能会出现在引擎的搜索结果中。如果想彻底对搜索引擎隐身那咋整呢?答案是：元标记，即meta tag。</p>
<p>比如要完全阻止一个网页的内容列在搜索引擎索引中(即使有其他网站链接到此网页)，可使用 noindex 元标记。只要搜索引擎查看该网页，便会看到 noindex 元标记并阻止该网页显示在索引中，这里注意noindex元标记提供的是一种逐页控制对网站的访问的方式。</p>
<p>要防止所有搜索引擎将网站中的网页编入索引，在网页的部分添加：</p>
<pre class="line-numbers language-vbscript-html" data-language="vbscript-html"><code class="language-vbscript-html">&lt;meta name="robots" content="noindex"&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>这里的name取值可以设置为某个搜索引擎的User-agent从而指定屏蔽某一个搜索引擎。</p>
<p>除了noindex外，还有其他元标记，比如说nofollow，禁止爬虫从此页面中跟踪链接。详细信息可以参考Google支持的元标记，这里提一句：noindex和nofollow在HTML 4.01规范里有描述，但是其他tag的在不同引擎支持到什么程度各不相同，还请读者自行查阅各个引擎的说明文档。</p>
<p><strong>Crawl-delay</strong><br>除了控制哪些可以抓哪些不能抓之外，robots.txt还可以用来控制爬虫抓取的速率。如何做到的呢?通过设置爬虫在两次抓取之间等待的秒数。这种操作可以进行缓解服务器压力。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">Crawl-delay:5<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>表示本次抓取后下一次抓取前需要等待5秒。</p>
<p>注意：google已经不支持这种方式了，在webmaster tools里提供了一个功能可以更直观的控制抓取速率。</p>
<p>这里插一句题外话，几年前曾经有一段时间robots.txt还支持复杂的参数:Visit-time，只有在visit-time指定的时间段里，爬虫才可以访问;Request-rate: 用来限制URL的读取频率，用于控制不同的时间段采用不同的抓取速率。后来估计支持的人太少，就渐渐的废掉了，目前google和baidu都已经不支持这个规则了，其他小的引擎公司貌似从来都没有支持过。</p>
<h3 id="Robots协议的遵守方式"><a href="#Robots协议的遵守方式" class="headerlink" title="Robots协议的遵守方式"></a>Robots协议的遵守方式</h3><p>网络爬虫：<br>自动或人工识别rotbots.txt，再进行内容爬取<br>约束性:<br>Robots协议是建议但非约束性，网络爬虫可以不遵守，但存在法律风险。</p>
<h3 id="对Robots协议的理解"><a href="#对Robots协议的理解" class="headerlink" title="对Robots协议的理解"></a>对Robots协议的理解</h3><table>
<thead>
<tr>
<th>访问量小:可以遵守<br>访问量较大：建议遵守</th>
<th>非商业且偶尔:建议遵守<br>商业利益:必须遵守</th>
<th>必须遵守</th>
</tr>
</thead>
<tbody><tr>
<td>爬取网页 玩转网页</td>
<td>爬取网站 爬取系列网站</td>
<td>爬取全网</td>
</tr>
<tr>
<td><code>原则</code>：类人行为可以不参考Robots协议。</td>
<td></td>
<td></td>
</tr>
</tbody></table>
<h3 id="防君子不防小人（君子协议）"><a href="#防君子不防小人（君子协议）" class="headerlink" title="防君子不防小人（君子协议）"></a>防君子不防小人（君子协议）</h3><p>Robots协议不是什么技术壁垒，而只是一种互相尊重的协议，好比私家花园的门口挂着“闲人免进”，尊重者绕道而行，不尊重者依然可以推门而入。目前，Robots协议在实际使用中，还存在一些问题。</p>
<h3 id="缓存"><a href="#缓存" class="headerlink" title="缓存"></a>缓存</h3><p>robots.txt本身也是需要抓取的，出于效率考虑，一般爬虫不会每次抓取网站网页前都抓一下robots.txt，加上robots.txt更新不频繁，内容需要解析。通常爬虫的做法是先抓取一次，解析后缓存下来，而且是相当长的时间。假设网站管理员更新了robots.txt，修改了某些规则，但是对爬虫来说并不会立刻生效，只有当爬虫下次抓取robots.txt之后才能看到最新的内容。尴尬的是，爬虫下次抓取robots.txt的时间并不是由网站管理员控制的。当然，有些搜索引擎提供了web 工具可以让网站管理员通知搜索引擎那个url发生了变化，建议重新抓取。注意，此处是建议，即使你通知了搜索引擎，搜索引擎何时抓取仍然是不确定的，只是比完全不通知要好点。至于好多少，那就看搜索引擎的良心和技术能力了。</p>
<h3 id="ignore"><a href="#ignore" class="headerlink" title="ignore"></a>ignore</h3><p>不知是无意还是有意，反正有些爬虫不太遵守或者完全忽略robots.txt，不排除开发人员能力的问题，比如说根本不知道robots.txt。另外，本身robots.txt不是一种强制措施，如果网站有数据需要保密，必需采取技术措施，比如说：用户验证，加密，ip拦截，访问频率控制等。</p>
<p><img src="https://raw.githubusercontent.com/jacksonyoudi/images/main/uPic/nGoP78.jpg"></p>
<h3 id="恶意爬虫"><a href="#恶意爬虫" class="headerlink" title="恶意爬虫"></a>恶意爬虫</h3><p>在互联网世界中，每天都有不计其数的爬虫在日夜不息地爬取数据，其中恶意爬虫的数量甚至高于非恶意爬虫。遵守Robots协议的爬虫才是好爬虫，但是并不是每个爬虫都会主动遵守Robots协议。</p>
<p>恶意爬虫可以带来很多潜在威胁，比如电商网站的商品信息被爬取可能会被竞争对手利用，过多的爬虫还会占用带宽资源、甚至导致网站宕机。</p>
<p>反恶意爬虫是一件漫长而艰巨的任务，如果依靠自身实力难以解决，可以借助岂安科技的业务风险分析平台 WARDEN 来反恶意爬虫，根据自己的需求来定制功能。</p>
]]></content>
      <categories>
        <category>技术</category>
      </categories>
      <tags>
        <tag>crawler</tag>
        <tag>爬虫</tag>
        <tag>robots</tag>
      </tags>
  </entry>
  <entry>
    <title>Hello World</title>
    <url>/2021/07/31/hello-world/</url>
    <content><![CDATA[<p>Welcome to <a href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ hexo new <span class="token string">"My New Post"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>More info: <a href="https://hexo.io/docs/writing.html">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ hexo server<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>More info: <a href="https://hexo.io/docs/server.html">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ hexo generate<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>More info: <a href="https://hexo.io/docs/generating.html">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ hexo deploy<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>More info: <a href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>
]]></content>
  </entry>
  <entry>
    <title>go mod使用</title>
    <url>/2021/07/31/go-mod-use/</url>
    <content><![CDATA[<p>最近由于换工作，开始交接工作。整理以前的工作内容，由于组内就我一个在做go和大数据。 所以开发没有规划，当时是怎么快怎么来。go也是使用最传统的go path的方式管理的。都是手动管理依赖的。现在交接给他人，需要多人开发，发现很多问题。比如版本问题，各种依赖的问题等等。</p>
<p>由于工作原因，几乎所有主流语言都写过。所以，对应语言包管理工具也都了解和使用过。我前面有写过maven的使用。<br>maven是使用过的功能最强大的包管理工具了，maven定位是项目管理工具。pip和npm都是及格的产品。</p>
<p>我个人觉得，一个包管理工具应该有以下功能：</p>
<h3 id="基本功能"><a href="#基本功能" class="headerlink" title="基本功能"></a>基本功能</h3><ol>
<li>依赖管理</li>
<li>依赖包版本控制</li>
<li>对应的包管理平台</li>
<li>可以私有化部署</li>
</ol>
<p>加分：<br>5. 代码包是否可以复用<br>6. 构建，测试,打包<br>7. 发布上线</p>
<p>对比上面几点：<br>目前做的最好的也就 maven了，gradle没有使用过，不知道。</p>
<p>今天主角是go mod，先来谈谈没有使用go mod之前的问题。</p>
<h3 id="使用go-path问题"><a href="#使用go-path问题" class="headerlink" title="使用go path问题"></a>使用go path问题</h3><ol>
<li>代码开发必须在go path src目录下，不然，就有问题。</li>
<li>依赖手动管理</li>
<li>依赖包没有版本可言</li>
</ol>
<p>从这个看， go path不算包管理工具</p>
<h3 id="govendor"><a href="#govendor" class="headerlink" title="govendor"></a>govendor</h3><ol>
<li>解决了包依赖，一个配置文件就管理</li>
<li>依赖包全都下载到项目vendor下，每个项目都把有一份。拉取项目时,开始怀疑人生。</li>
</ol>
<h3 id="go-mod介绍"><a href="#go-mod介绍" class="headerlink" title="go mod介绍"></a>go mod介绍</h3><p>go modules 是 golang 1.11 新加的特性。现在1.12 已经发布了，是时候用起来了。Modules官方定义为：</p>
<blockquote>
<p>模块是相关Go包的集合。modules是源代码交换和版本控制的单元。 go命令直接支持使用modules，包括记录和解析对其他模块的依赖性。modules替换旧的基于GOPATH的方法来指定在给定构建中使用哪些源文件。</p>
</blockquote>
<h3 id="如何使用go-mod"><a href="#如何使用go-mod" class="headerlink" title="如何使用go mod"></a>如何使用go mod</h3><p>首先，必须升级go到1.11,目前版本是1.14<br>下面我以我自己升级演示：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">
<span class="token comment">### 卸载旧版本，删除对应文件</span>
brew uninstall -f go

<span class="token comment">### 更新一下brew</span>

brew update


<span class="token comment">### 安装go</span>
brew <span class="token function">install</span> go<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>上面升级完了，使用 <code>go version</code>看下版本</p>
<pre class="line-numbers language-none"><code class="language-none">go version go1.14.1 darwin/amd64<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>下面设置go mod和go proxy</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">go <span class="token function">env</span> -w <span class="token assign-left variable">GOBIN</span><span class="token operator">=</span>/Users/youdi/go/bin
go <span class="token function">env</span> -w <span class="token assign-left variable">GO111MODULE</span><span class="token operator">=</span>on
go <span class="token function">env</span> -w <span class="token assign-left variable">GOPROXY</span><span class="token operator">=</span>https://goproxy.cn,direct // 使用七牛云的<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>注意： go env -w会将配置写到  <code>GOENV="/Users/youdi/Library/Application Support/go/env"</code></p>
<p>下面看下我的配置</p>
<pre class="line-numbers language-none"><code class="language-none">GO111MODULE="on"
GOARCH="amd64"
GOBIN="/Users/youdi/go/bin"
GOCACHE="/Users/youdi/Library/Caches/go-build"
GOENV="/Users/youdi/Library/Application Support/go/env"
GOEXE=""
GOFLAGS=""
GOHOSTARCH="amd64"
GOHOSTOS="darwin"
GOINSECURE=""
GONOPROXY=""
GONOSUMDB=""
GOOS="darwin"
GOPATH="/Users/youdi/go"
GOPRIVATE=""
GOPROXY="https://goproxy.cn,direct"
GOROOT="/usr/local/go"
GOSUMDB="off"
GOTMPDIR=""
GOTOOLDIR="/usr/local/go/pkg/tool/darwin_amd64"
GCCGO="gccgo"
AR="ar"
CC="clang"
CXX="clang++"
CGO_ENABLED="1"
GOMOD="/dev/null"
CGO_CFLAGS="-g -O2"
CGO_CPPFLAGS=""
CGO_CXXFLAGS="-g -O2"
CGO_FFLAGS="-g -O2"
CGO_LDFLAGS="-g -O2"
PKG_CONFIG="pkg-config"
GOGCCFLAGS="-fPIC -m64 -pthread -fno-caret-diagnostics -Qunused-arguments -fmessage-length=0 -fdebug-prefix-map=/var/folders/8m/v_1j4dgs7rzgqq4p_4_8k_nr0000gn/T/go-build221113671=/tmp/go-build -gno-record-gcc-switches -fno-common"
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<p>我们看一下，我修改的内容</p>
<p>cat /Users/youdi/Library/Application Support/go/env</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token assign-left variable">GO111MODULE</span><span class="token operator">=</span>on
<span class="token assign-left variable">GOBIN</span><span class="token operator">=</span>/Users/youdi/go/bin
<span class="token assign-left variable">GOPROXY</span><span class="token operator">=</span>https://goproxy.cn,direct
<span class="token assign-left variable">GOSUMDB</span><span class="token operator">=</span>off<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>


<h3 id="GO111MODULE"><a href="#GO111MODULE" class="headerlink" title="GO111MODULE"></a>GO111MODULE</h3><p>GO111MODULE 有三个值：off, on和auto（默认值）。</p>
<p>GO111MODULE=off，go命令行将不会支持module功能，寻找依赖包的方式将会沿用旧版本那种通过vendor目录或者GOPATH模式来查找。<br>GO111MODULE=on，go命令行会使用modules，而一点也不会去GOPATH目录下查找。<br>GO111MODULE=auto，默认值，go命令行将会根据当前目录来决定是否启用module功能。这种情况下可以分为两种情形：</p>
<pre><code>当前目录在GOPATH/src之外且该目录包含go.mod文件
当前文件在包含go.mod文件的目录下面。
</code></pre>
<p>当modules功能启用时，依赖包的存放位置变更为$GOPATH/pkg，允许同一个package多个版本并存，且多个项目可以共享缓存的 module</p>
<p>我们看下目录：</p>
<p>cd /Users/youdi/go/pkg</p>
<pre class="line-numbers language-none"><code class="language-none">├── darwin_amd64
│&nbsp;&nbsp; ├── github.com
│&nbsp;&nbsp; ├── go.etcd.io
│&nbsp;&nbsp; ├── golang
│&nbsp;&nbsp; ├── golang.org
│&nbsp;&nbsp; ├── gopkg.in
│&nbsp;&nbsp; ├── quickstart
│&nbsp;&nbsp; └── uc.a
├── mod
│&nbsp;&nbsp; ├── cache
│&nbsp;&nbsp; ├── github.com
│&nbsp;&nbsp; ├── golang.org
│&nbsp;&nbsp; ├── google.golang.org
│&nbsp;&nbsp; └── gopkg.in
└── sumdb
    └── sum.golang.org<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<h3 id="go-mod命令"><a href="#go-mod命令" class="headerlink" title="go mod命令"></a>go mod命令</h3><p>golang 提供了 <code>go mod</code>命令来管理包。</p>
<p>go help mod</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">
Go mod provides access to operations on modules.

Note that support <span class="token keyword">for</span> modules is built into all the go commands,
not just <span class="token string">'go mod'</span><span class="token builtin class-name">.</span> For example, day-to-day adding, removing, upgrading,
and downgrading of dependencies should be <span class="token keyword">done</span> using <span class="token string">'go get'</span><span class="token builtin class-name">.</span>
See <span class="token string">'go help modules'</span> <span class="token keyword">for</span> an overview of module functionality.

Usage:

	go mod <span class="token operator">&lt;</span>command<span class="token operator">&gt;</span> <span class="token punctuation">[</span>arguments<span class="token punctuation">]</span>

The commands are:

	download    download modules to <span class="token builtin class-name">local</span> cache
	edit        edit go.mod from tools or scripts
	graph       print module requirement graph
	init        initialize new module <span class="token keyword">in</span> current directory
	tidy        <span class="token function">add</span> missing and remove unused modules
	vendor      <span class="token function">make</span> vendored copy of dependencies
	verify      verify dependencies have expected content
	why         explain why packages or modules are needed

Use <span class="token string">"go help mod &lt;command&gt;"</span> <span class="token keyword">for</span> <span class="token function">more</span> information about a command.
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>go mod 有以下命令：</p>
<table>
<thead>
<tr>
<th>命令</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>download</td>
<td>download modules to local cache(下载依赖包)</td>
</tr>
<tr>
<td>edit</td>
<td>edit go.mod from tools or scripts（编辑go.mod)</td>
</tr>
<tr>
<td>graph</td>
<td>print module requirement graph (打印模块依赖图)</td>
</tr>
<tr>
<td>verify</td>
<td>initialize new module in current directory（在当前目录初始化mod）</td>
</tr>
<tr>
<td>tidy</td>
<td>add missing and remove unused modules(拉取缺少的模块，移除不用的模块)</td>
</tr>
<tr>
<td>vendor</td>
<td>make vendored copy of dependencies(将依赖复制到vendor下)</td>
</tr>
<tr>
<td>verify</td>
<td>verify dependencies have expected content (验证依赖是否正确）</td>
</tr>
<tr>
<td>why</td>
<td>explain why packages or modules are needed(解释为什么需要依赖)</td>
</tr>
</tbody></table>
<p>比较常用的是 <code>init</code>,<code>tidy</code>, <code>edit</code></p>
<h3 id="使用go-mod管理一个新项目"><a href="#使用go-mod管理一个新项目" class="headerlink" title="使用go mod管理一个新项目"></a>使用go mod管理一个新项目</h3><h4 id="1-初始化项目"><a href="#1-初始化项目" class="headerlink" title="1. 初始化项目"></a>1. 初始化项目</h4><p>可以随便找一个目录创建项目，我使用习惯用IDEA进行创建</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">mkdir</span> Gone
<span class="token builtin class-name">cd</span> Gone
go mod init Gone<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>查看一下 go.mod文件</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go">module Gone

<span class="token keyword">go</span> <span class="token number">1.14</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>go.mod文件一旦创建后，它的内容将会被go toolchain全面掌控。go toolchain会在各类命令执行时，比如go get、go build、go mod等修改和维护go.mod文件。</p>
<p>go.mod 提供了module, require、replace和exclude 四个命令</p>
<ul>
<li><code>module</code> 语句指定包的名字（路径）</li>
<li><code>require</code> 语句指定的依赖项模块</li>
<li><code>replace</code> 语句可以替换依赖项模块</li>
<li><code>exclude</code> 语句可以忽略依赖项模块</li>
</ul>
<h4 id="2-添加依赖"><a href="#2-添加依赖" class="headerlink" title="2. 添加依赖"></a>2. 添加依赖</h4><p>创建 main.go文件</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"github.com/gin-gonic/gin"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	r <span class="token operator">:=</span> gin<span class="token punctuation">.</span><span class="token function">Default</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	r<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">"/ping"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		c<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{</span>
			<span class="token string">"message"</span><span class="token punctuation">:</span> <span class="token string">"pong"</span><span class="token punctuation">,</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
	r<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// listen and serve on 0.0.0.0:8080 (for windows "localhost:8080")</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<p>执行 go run main.go 运行代码会发现 go mod 会自动查找依赖自动下载<br>再查看 <code>go.mod</code></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">module Gone

go <span class="token number">1.14</span>

require github.com/gin-gonic/gin v1.6.3<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>go module 安装 package 的原則是先拉最新的 release tag，若无tag则拉最新的commit</p>
<p>go 会自动生成一个 go.sum 文件来记录 dependency tree</p>
<p><img src="https://raw.githubusercontent.com/jacksonyoudi/images/main/uPic/JhSGHb.jpg"></p>
<p>再次执行脚本 go run main.go发现跳过了检查并安装依赖的步骤。</p>
<p>可以使用命令 go list -m -u all 来检查可以升级的package，使用go get -u need-upgrade-package 升级后会将新的依赖版本更新到go.mod * 也可以使用 go get -u 升级所有依赖</p>
<p>去mod包缓存下看看</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">/Users/youdi/go/pkg/mod/github.com/gin-gonic/gin@v1.6.3<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>


<h3 id="go-get升级"><a href="#go-get升级" class="headerlink" title="go get升级"></a>go get升级</h3><ul>
<li>运行 go get -u 将会升级到最新的次要版本或者修订版本(x.y.z, z是修订版本号， y是次要版本号)</li>
<li>运行 go get -u=patch 将会升级到最新的修订版本</li>
<li>运行 go get package@version 将会升级到指定的版本号version</li>
<li>运行go get如果有版本的更改，那么go.mod文件也会更改</li>
</ul>
<h3 id="使用replace替换无法直接获取的package"><a href="#使用replace替换无法直接获取的package" class="headerlink" title="使用replace替换无法直接获取的package"></a>使用replace替换无法直接获取的package</h3><p>由于某些已知的原因，并不是所有的package都能成功下载，比如：golang.org下的包。</p>
<p>modules 可以通过在 go.mod 文件中使用 replace 指令替换成github上对应的库，比如：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go">replace <span class="token punctuation">(</span>
	golang<span class="token punctuation">.</span>org<span class="token operator">/</span>x<span class="token operator">/</span>crypto v0<span class="token punctuation">.</span><span class="token number">0.0</span><span class="token operator">-</span><span class="token number">20190313024323</span><span class="token operator">-</span>a1f597ede03a <span class="token operator">=</span><span class="token operator">&gt;</span> github<span class="token punctuation">.</span>com<span class="token operator">/</span>golang<span class="token operator">/</span>crypto v0<span class="token punctuation">.</span><span class="token number">0.0</span><span class="token operator">-</span><span class="token number">20190313024323</span><span class="token operator">-</span>a1f597ede03a
<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h3 id="go-mod发布和使用"><a href="#go-mod发布和使用" class="headerlink" title="go mod发布和使用"></a>go mod发布和使用</h3><p>参考Roberto Selbach写的go mod入门文章，文末，我给出链接</p>
<h3 id="Creating-a-Module"><a href="#Creating-a-Module" class="headerlink" title="Creating a Module"></a>Creating a Module</h3><p>如果你设置好go mod了，那你就可以在任何目录下随便创建</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token variable">$mkdir</span> gomodone
<span class="token variable">$cd</span> gomodone<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>在这个目录下创建一个文件<code>say.go</code></p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> gomodone

<span class="token keyword">import</span> <span class="token string">"fmt"</span> 

<span class="token comment">// say Hi to someone</span>
<span class="token keyword">func</span> <span class="token function">SayHi</span><span class="token punctuation">(</span>name <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
   <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"Hi, %s"</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>初始化一个 <code>go.mod</code>文件</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ go mod init github.com/jacksonyoudi/gomodone
go: creating new go.mod: module github.com/jacksonyoudi/gomodone<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>查看 go.mod内容如下：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go">github<span class="token punctuation">.</span>com<span class="token operator">/</span>jacksonyoudi<span class="token operator">/</span>gomodone
<span class="token keyword">go</span> <span class="token number">1.14</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>下面我们要将这个module发布到github上，然后在另外一个程序使用</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token variable">$git</span> init
<span class="token variable">$vim</span> .gitiiignore
<span class="token variable">$git</span> commit -am <span class="token string">"init"</span>
// github创建对应的repo
<span class="token variable">$git</span> remote <span class="token function">add</span> origin git@github.com:jacksonyoudi/gomodone.git
<span class="token variable">$git</span> push -u origin master<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>执行完，上面我们就相当于发布完了。</p>
<p>如果有人需要使用，就可以使用</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">go get github.com/jacksonyoudi/gomodone<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>这个时候没有加tag，所以，没有版本的控制。默认是v0.0.0后面接上时间和commitid。如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">gomodone@v0.0.0-20200517004046-ee882713fd1e<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>官方不建议这样做，没有进行版本控制管理。</p>
<h3 id="module-versioning"><a href="#module-versioning" class="headerlink" title="module versioning"></a>module versioning</h3><p>使用tag，进行版本控制</p>
<h4 id="making-a-release"><a href="#making-a-release" class="headerlink" title="making a release"></a>making a release</h4><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">git</span> tag v1.0.0
<span class="token function">git</span> push --tags<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>操作完，我们的module就发布了一个v1.0.0的版本了。</p>
<p>推荐在这个状态下，再切出一个分支，用于后续v1.0.0的修复推送,不要直接在master分支修复</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token variable">$git</span> checkout -b v1
<span class="token variable">$git</span> push -u origin v1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>


<h3 id="use-our-module"><a href="#use-our-module" class="headerlink" title="use our module"></a>use our module</h3><p>上面已经发布了一个v1.0.0的版本，我们可以在另一个项目中使用，创建一个go的项目</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token variable">$mkdir</span> Gone
<span class="token variable">$cd</span> Gone
<span class="token variable">$vim</span> main.go<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"fmt"</span>
	<span class="token string">"github.com/jacksonyoudi/gomodone"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>gomodone<span class="token punctuation">.</span><span class="token function">SayHi</span><span class="token punctuation">(</span><span class="token string">"Roberto"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>代码写好了，我们生成 go mod文件</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">go mod init Gone<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>上面命令执行完，会生成 go mod文件<br>看下mod文件：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">module Gone

go <span class="token number">1.14</span>

require <span class="token punctuation">(</span>
	github.com/jacksonyoudi/gomodone v1.0.0
<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token variable">$go</span> mod tidy
go: finding module <span class="token keyword">for</span> package github.com/jacksonyoudi/gomodone
go: found github.com/jacksonyoudi/gomodone <span class="token keyword">in</span> github.com/jacksonyoudi/gomodone v1.0.0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>同时还生成了go.sum, 其中包含软件包的哈希值，以确保我们具有正确的版本和文件。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">github.com/jacksonyoudi/gomodone v1.0.1 h1:jFd+qZlAB0R3zqrC9kwO8IgPrAdayMUS0rSHMDc/uG8<span class="token operator">=</span>
github.com/jacksonyoudi/gomodone v1.0.1/go.mod h1:XWi+BLbuiuC2YM8Qz4yQzTSPtHt3T3hrlNN2pNlyA94<span class="token operator">=</span>
github.com/jacksonyoudi/gomodone/v2 v2.0.0 h1:GpzGeXCx/Xv2ueiZJ8hEhFwLu7xjxLBjkOYSmg8Ya/w<span class="token operator">=</span>
github.com/jacksonyoudi/gomodone/v2 v2.0.0/go.mod h1:L8uFPSZNHoAhpaePWUfKmGinjufYdw9c2i70xtBorSw<span class="token operator">=</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个内容是下面的，需要操作执行的结果</p>
<p>go run main.go就可以运行了</p>
<h3 id="Making-a-bugfix-release"><a href="#Making-a-bugfix-release" class="headerlink" title="Making a bugfix release"></a>Making a bugfix release</h3><p>假如fix一个bug,我们在v1版本上进行修复</p>
<p>修改代码如下：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// say Hi to someone</span>
<span class="token keyword">func</span> <span class="token function">SayHi</span><span class="token punctuation">(</span>name <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
<span class="token operator">-</span>       <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"Hi, %s"</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span>
<span class="token operator">+</span>       <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"Hi, %s!"</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>修复好，我们开始push</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">git</span> commit -m <span class="token string">"Emphasize our friendliness"</span> say.go
$ <span class="token function">git</span> tag v1.0.1
$ <span class="token function">git</span> push --tags origin v1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h4 id="Updating-modules"><a href="#Updating-modules" class="headerlink" title="Updating modules"></a>Updating modules</h4><p>刚才fix bug，所以要在我们使用项目中更新</p>
<p>这个需要我们手动执行更新module操作</p>
<p>我们通过使用我们的好朋友来做到这一点go get：</p>
<ul>
<li>运行  <code>go get -u</code> 以使用最新的  minor  版本或修补程序版本（即它将从1.0.0更新到例如1.0.1，或者，如果可用，则更新为1.1.0）</li>
<li>运行  go get -u=patch 以使用最新的  修补程序  版本（即，将更新为1.0.1但不更新  为1.1.0）</li>
<li>运行go get package@version 以更新到特定版本（例如github.com/jacksonyoudi/<a href="mailto:gomodone@v1.0.1">gomodone@v1.0.1</a>）</li>
</ul>
<p>目前module最新的也是v1.0.1</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">// 更新最新
<span class="token variable">$go</span> get -u
<span class="token variable">$go</span> get -u<span class="token operator">=</span>patch
//指定包，指定版本
<span class="token variable">$go</span> get github.com/jacksonyoudi/gomodone@v1.0.1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>操作完，go.mod文件会修改如下:</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go">module Gone

<span class="token keyword">go</span> <span class="token number">1.14</span>

require <span class="token punctuation">(</span>
	github<span class="token punctuation">.</span>com<span class="token operator">/</span>jacksonyoudi<span class="token operator">/</span>gomodone v1<span class="token punctuation">.</span><span class="token number">0.1</span>
<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h4 id="Major-versions"><a href="#Major-versions" class="headerlink" title="Major versions"></a>Major versions</h4><p>根据语义版本语义，主要版本与次要版本  不同。主要版本可能会破坏向后兼容性。从Go模块的角度来看，主要版本是  完全不同的软件包。乍一看这听起来很奇怪，但这是有道理的：两个不兼容的库版本是两个不同的库。<br>比如下面修改，完全破坏了兼容性。</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> gomodone

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"errors"</span>
	<span class="token string">"fmt"</span>
<span class="token punctuation">)</span>

<span class="token comment">// Hi returns a friendly greeting</span>
<span class="token comment">// Hi returns a friendly greeting in language lang</span>
<span class="token keyword">func</span> <span class="token function">SayHi</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> lang <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">switch</span> lang <span class="token punctuation">{</span>
	<span class="token keyword">case</span> <span class="token string">"en"</span><span class="token punctuation">:</span>
		<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"Hi, %s!"</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
	<span class="token keyword">case</span> <span class="token string">"pt"</span><span class="token punctuation">:</span>
		<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"Oi, %s!"</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
	<span class="token keyword">case</span> <span class="token string">"es"</span><span class="token punctuation">:</span>
		<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"¡Hola, %s!"</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
	<span class="token keyword">case</span> <span class="token string">"fr"</span><span class="token punctuation">:</span>
		<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"Bonjour, %s!"</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
	<span class="token keyword">default</span><span class="token punctuation">:</span>
		<span class="token keyword">return</span> <span class="token string">""</span><span class="token punctuation">,</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"unknown language"</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<p>如上，我们需要不同的大版本，这种情况下</p>
<p>修改 go.mod如下</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go">module github<span class="token punctuation">.</span>com<span class="token operator">/</span>jacksonyoudi<span class="token operator">/</span>gomodone<span class="token operator">/</span>v2

<span class="token keyword">go</span> <span class="token number">1.14</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>然后，重新tag，push</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">git</span> commit say.go -m <span class="token string">"Change Hi to allow multilang"</span>
$ <span class="token function">git</span> checkout -b v2 <span class="token comment"># 用于v2版本，后续修复v2</span>
$ <span class="token function">git</span> commit go.mod -m <span class="token string">"Bump version to v2"</span>
$ <span class="token function">git</span> tag v2.0.0
$ <span class="token function">git</span> push --tags origin v2 <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="Updating-to-a-major-version"><a href="#Updating-to-a-major-version" class="headerlink" title="Updating to a major version"></a>Updating to a major version</h3><p>即使发布了库的新不兼容版本，现有软件 也不会中断，因为它将继续使用现有版本1.0.1。go get -u 将不会获得版本2.0.0。<br>如果想使用v2.0.0,代码改成如下：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"fmt"</span>
    <span class="token string">"github.com/jacksonyoudi/gomodone/v2"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	g<span class="token punctuation">,</span> err <span class="token operator">:=</span> gomodone<span class="token punctuation">.</span><span class="token function">SayHi</span><span class="token punctuation">(</span><span class="token string">"Roberto"</span><span class="token punctuation">,</span> <span class="token string">"pt"</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>g<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>执行 go mod tidy</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">go: finding module <span class="token keyword">for</span> package github.com/jacksonyoudi/gomodone/v2
go: downloading github.com/jacksonyoudi/gomodone/v2 v2.0.0
go: found github.com/jacksonyoudi/gomodone/v2 <span class="token keyword">in</span> github.com/jacksonyoudi/gomodone/v2 v2.0.0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>当然，两个版本都可以同时使用, 使用别名<br>如下：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"fmt"</span>
	<span class="token string">"github.com/jacksonyoudi/gomodone"</span>
	mv2 <span class="token string">"github.com/jacksonyoudi/gomodone/v2"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	g<span class="token punctuation">,</span> err <span class="token operator">:=</span> mv2<span class="token punctuation">.</span><span class="token function">SayHi</span><span class="token punctuation">(</span><span class="token string">"Roberto"</span><span class="token punctuation">,</span> <span class="token string">"pt"</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>g<span class="token punctuation">)</span>

	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>gomodone<span class="token punctuation">.</span><span class="token function">SayHi</span><span class="token punctuation">(</span><span class="token string">"Roberto"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>执行一下 <code>go mod tidy</code></p>
<h3 id="Vendoring"><a href="#Vendoring" class="headerlink" title="Vendoring"></a>Vendoring</h3><p>默认是忽略vendor的，如果想在项目目录下有vendor可以执行下面命令</p>
<pre class="line-numbers language-none"><code class="language-none">$go vendor<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>当然，如果构建程序的时候，希望使用vendor中的依赖，</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go">$ <span class="token keyword">go</span> build <span class="token operator">-</span>mod vendor<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>


<h3 id="IDEA下开发GO"><a href="#IDEA下开发GO" class="headerlink" title="IDEA下开发GO"></a>IDEA下开发GO</h3><ol>
<li>创建go项目</li>
</ol>
<p><img src="https://raw.githubusercontent.com/jacksonyoudi/images/main/uPic/IqR0yI.jpg"></p>
<ol start="2">
<li><p>创建完项目，会自动生成go mod文件<br>如果需要修改，可以手动修改，加入git等操作</p>
</li>
<li><p>写业务逻辑代码</p>
</li>
</ol>
<p><img src="https://raw.githubusercontent.com/jacksonyoudi/images/main/uPic/ZNN4tE.jpg"><br>4. 解决依赖，更新go.mod</p>
<p><img src="https://raw.githubusercontent.com/jacksonyoudi/images/main/uPic/CxoGM9.jpg"></p>
<ol start="5">
<li>go build</li>
</ol>
]]></content>
      <categories>
        <category>技术</category>
      </categories>
      <tags>
        <tag>go</tag>
        <tag>tool</tag>
        <tag>language</tag>
      </tags>
  </entry>
  <entry>
    <title>spark加载数据到ES</title>
    <url>/2021/08/01/spark-load-to-es/</url>
    <content><![CDATA[<p>在日常开发中一定会遇到，spark将计算好的数据load到es中，供后端同学查询使用。下面介绍一下spark写es的方式。 使用scala进行演示，对应的java自己google了。</p>
<p>spark写es需要使用到 对应的包es包。maven配置如下</p>
<h2 id="MAVEN配置"><a href="#MAVEN配置" class="headerlink" title="MAVEN配置"></a>MAVEN配置</h2><pre class="line-numbers language-maven" data-language="maven"><code class="language-maven">&lt;dependency&gt;
    &lt;groupId&gt;org.apache.spark&lt;/groupId&gt;
    &lt;artifactId&gt;spark-core_2.12&lt;/artifactId&gt;
    &lt;version&gt;3.0.0&lt;/version&gt;
&lt;/dependency&gt;

&lt;dependency&gt;
    &lt;groupId&gt;org.elasticsearch&lt;/groupId&gt;
    &lt;artifactId&gt;elasticsearch-hadoop&lt;/artifactId&gt;
    &lt;version&gt;7.0.0&lt;/version&gt;
&lt;/dependency&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<h3 id="使用MAP方式"><a href="#使用MAP方式" class="headerlink" title="使用MAP方式"></a>使用MAP方式</h3><p>代码如下</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">package org<span class="token punctuation">.</span>bigdata<span class="token punctuation">.</span>es

<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>{SparkConf<span class="token punctuation">,</span> SparkContext}
<span class="token keyword">import</span> org<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>_

object D01 {
  def main<span class="token punctuation">(</span>args: Array<span class="token punctuation">[</span>String<span class="token punctuation">]</span><span class="token punctuation">)</span>: Unit <span class="token operator">=</span> {
    val conf: SparkConf <span class="token operator">=</span> new SparkConf<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setAppName<span class="token punctuation">(</span><span class="token string">"d01"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setMaster<span class="token punctuation">(</span><span class="token string">"local[*]"</span><span class="token punctuation">)</span>
    conf<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span><span class="token string">"es.index.auto.create"</span><span class="token punctuation">,</span> <span class="token string">"true"</span><span class="token punctuation">)</span>

    val sc: SparkContext <span class="token operator">=</span> new SparkContext<span class="token punctuation">(</span>conf<span class="token punctuation">)</span>

    <span class="token comment">// map方式</span>
    val numbers <span class="token operator">=</span> Map<span class="token punctuation">(</span><span class="token string">"one"</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"two"</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"three"</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token number">3</span><span class="token punctuation">)</span>
    val airports <span class="token operator">=</span> Map<span class="token punctuation">(</span><span class="token string">"arrival"</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token string">"Otopeni"</span><span class="token punctuation">,</span> <span class="token string">"SFO"</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token string">"San Fran"</span><span class="token punctuation">)</span>
    sc<span class="token punctuation">.</span>makeRDD<span class="token punctuation">(</span>Seq<span class="token punctuation">(</span>numbers<span class="token punctuation">,</span> airports<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>saveToEs<span class="token punctuation">(</span><span class="token string">"spark/docs"</span><span class="token punctuation">)</span>

  }
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>注意： 必须要导入 <strong>import org.elasticsearch.spark._</strong>, 不然，就没有 <code>saveToEs</code>方法了</p>
<p>下面介绍一下， org.elasticsearch.spark._ 导入的隐式函数</p>
<p><img src="https://raw.githubusercontent.com/jacksonyoudi/images/main/uPic/uJdnvn.jpg" alt="包对象中隐式函数"></p>
<p>在 org.elasticsearch.spark._  下面的包对象中有 一个隐式函数，将 RDD转成 SparkRDDFunctions</p>
<h3 id="反编译成-java代码"><a href="#反编译成-java代码" class="headerlink" title="反编译成 java代码"></a>反编译成 java代码</h3> <pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">org<span class="token punctuation">.</span>bigdata<span class="token punctuation">.</span>es</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span></span><span class="token class-name">SparkConf</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span></span><span class="token class-name">SparkContext</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">scala<span class="token punctuation">.</span>collection<span class="token punctuation">.</span></span><span class="token class-name">Seq</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">scala<span class="token punctuation">.</span>collection<span class="token punctuation">.</span>immutable<span class="token punctuation">.</span></span><span class="token class-name">Map</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">scala<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span></span><span class="token class-name">BoxesRunTime</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> D01$ <span class="token punctuation">{</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> D01$ MODULE$<span class="token punctuation">;</span>
  
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">SparkConf</span> conf <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SparkConf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAppName</span><span class="token punctuation">(</span><span class="token string">"d01"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setMaster</span><span class="token punctuation">(</span><span class="token string">"local[*]"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    conf<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"es.index.auto.create"</span><span class="token punctuation">,</span> <span class="token string">"true"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">SparkContext</span> sc <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SparkContext</span><span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name"><span class="token namespace">scala<span class="token punctuation">.</span></span>Tuple2</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token class-name"><span class="token namespace">scala<span class="token punctuation">.</span></span>Predef</span>$<span class="token class-name">ArrowAssoc</span>$<span class="token punctuation">.</span>MODULE$<span class="token punctuation">.</span>$minus$greater$<span class="token function">extension</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">scala<span class="token punctuation">.</span></span>Predef</span>$<span class="token punctuation">.</span>MODULE$<span class="token punctuation">.</span><span class="token function">ArrowAssoc</span><span class="token punctuation">(</span><span class="token string">"one"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">BoxesRunTime</span><span class="token punctuation">.</span><span class="token function">boxToInteger</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name"><span class="token namespace">scala<span class="token punctuation">.</span></span>Tuple2</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token class-name"><span class="token namespace">scala<span class="token punctuation">.</span></span>Predef</span>$<span class="token class-name">ArrowAssoc</span>$<span class="token punctuation">.</span>MODULE$<span class="token punctuation">.</span>$minus$greater$<span class="token function">extension</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">scala<span class="token punctuation">.</span></span>Predef</span>$<span class="token punctuation">.</span>MODULE$<span class="token punctuation">.</span><span class="token function">ArrowAssoc</span><span class="token punctuation">(</span><span class="token string">"two"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">BoxesRunTime</span><span class="token punctuation">.</span><span class="token function">boxToInteger</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name"><span class="token namespace">scala<span class="token punctuation">.</span></span>Tuple2</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token class-name"><span class="token namespace">scala<span class="token punctuation">.</span></span>Predef</span>$<span class="token class-name">ArrowAssoc</span>$<span class="token punctuation">.</span>MODULE$<span class="token punctuation">.</span>$minus$greater$<span class="token function">extension</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">scala<span class="token punctuation">.</span></span>Predef</span>$<span class="token punctuation">.</span>MODULE$<span class="token punctuation">.</span><span class="token function">ArrowAssoc</span><span class="token punctuation">(</span><span class="token string">"three"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">BoxesRunTime</span><span class="token punctuation">.</span><span class="token function">boxToInteger</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Map</span> numbers <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token punctuation">)</span><span class="token class-name"><span class="token namespace">scala<span class="token punctuation">.</span></span>Predef</span>$<span class="token punctuation">.</span>MODULE$<span class="token punctuation">.</span><span class="token function">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Seq</span><span class="token punctuation">)</span><span class="token class-name"><span class="token namespace">scala<span class="token punctuation">.</span></span>Predef</span>$<span class="token punctuation">.</span>MODULE$<span class="token punctuation">.</span><span class="token function">wrapRefArray</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">new</span> <span class="token class-name"><span class="token namespace">scala<span class="token punctuation">.</span></span>Tuple2</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name"><span class="token namespace">scala<span class="token punctuation">.</span></span>Tuple2</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token class-name"><span class="token namespace">scala<span class="token punctuation">.</span></span>Predef</span>$<span class="token class-name">ArrowAssoc</span>$<span class="token punctuation">.</span>MODULE$<span class="token punctuation">.</span>$minus$greater$<span class="token function">extension</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">scala<span class="token punctuation">.</span></span>Predef</span>$<span class="token punctuation">.</span>MODULE$<span class="token punctuation">.</span><span class="token function">ArrowAssoc</span><span class="token punctuation">(</span><span class="token string">"arrival"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"Otopeni"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name"><span class="token namespace">scala<span class="token punctuation">.</span></span>Tuple2</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token class-name"><span class="token namespace">scala<span class="token punctuation">.</span></span>Predef</span>$<span class="token class-name">ArrowAssoc</span>$<span class="token punctuation">.</span>MODULE$<span class="token punctuation">.</span>$minus$greater$<span class="token function">extension</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">scala<span class="token punctuation">.</span></span>Predef</span>$<span class="token punctuation">.</span>MODULE$<span class="token punctuation">.</span><span class="token function">ArrowAssoc</span><span class="token punctuation">(</span><span class="token string">"SFO"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"San Fran"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Map</span> airports <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token punctuation">)</span><span class="token class-name"><span class="token namespace">scala<span class="token punctuation">.</span></span>Predef</span>$<span class="token punctuation">.</span>MODULE$<span class="token punctuation">.</span><span class="token function">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Seq</span><span class="token punctuation">)</span><span class="token class-name"><span class="token namespace">scala<span class="token punctuation">.</span></span>Predef</span>$<span class="token punctuation">.</span>MODULE$<span class="token punctuation">.</span><span class="token function">wrapRefArray</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">new</span> <span class="token class-name"><span class="token namespace">scala<span class="token punctuation">.</span></span>Tuple2</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> numbers<span class="token punctuation">;</span>
    <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> airports<span class="token punctuation">;</span>
    org<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>spark<span class="token punctuation">.</span><span class="token keyword">package</span>$<span class="token punctuation">.</span>MODULE$<span class="token punctuation">.</span><span class="token function">sparkRDDFunctions</span><span class="token punctuation">(</span>sc<span class="token punctuation">.</span><span class="token function">makeRDD</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Seq</span><span class="token punctuation">)</span><span class="token class-name"><span class="token namespace">scala<span class="token punctuation">.</span>collection<span class="token punctuation">.</span></span>Seq</span>$<span class="token punctuation">.</span>MODULE$<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Seq</span><span class="token punctuation">)</span><span class="token class-name"><span class="token namespace">scala<span class="token punctuation">.</span></span>Predef</span>$<span class="token punctuation">.</span>MODULE$<span class="token punctuation">.</span><span class="token function">wrapRefArray</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> sc<span class="token punctuation">.</span>makeRDD$<span class="token keyword">default</span>$<span class="token function">2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name"><span class="token namespace">scala<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span>ClassTag</span>$<span class="token punctuation">.</span>MODULE$<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name"><span class="token namespace">scala<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span>ClassTag</span>$<span class="token punctuation">.</span>MODULE$<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">saveToEs</span><span class="token punctuation">(</span><span class="token string">"spark/docs"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token keyword">private</span> D01$<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    MODULE$ <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p>再给一下，其他的 写es的代码</p>
<h2 id="其他方式写ES"><a href="#其他方式写ES" class="headerlink" title="其他方式写ES"></a>其他方式写ES</h2><h3 id="使用样例类方式"><a href="#使用样例类方式" class="headerlink" title="使用样例类方式"></a>使用样例类方式</h3><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala">
<span class="token keyword">package</span> <span class="token namespace">org<span class="token punctuation">.</span>bigdata<span class="token punctuation">.</span>es</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>rdd<span class="token punctuation">.</span></span>RDD
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span></span><span class="token punctuation">{</span>SparkConf<span class="token punctuation">,</span> SparkContext<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>rdd<span class="token punctuation">.</span></span>EsSpark

<span class="token keyword">object</span> D02 <span class="token punctuation">{</span>
  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token keyword">val</span> conf<span class="token operator">:</span> SparkConf <span class="token operator">=</span> <span class="token keyword">new</span> SparkConf<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setAppName<span class="token punctuation">(</span><span class="token string">"d01"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setMaster<span class="token punctuation">(</span><span class="token string">"local[*]"</span><span class="token punctuation">)</span>
    conf<span class="token punctuation">.</span>set<span class="token punctuation">(</span><span class="token string">"es.index.auto.create"</span><span class="token punctuation">,</span> <span class="token string">"true"</span><span class="token punctuation">)</span>

    <span class="token keyword">val</span> sc<span class="token operator">:</span> SparkContext <span class="token operator">=</span> <span class="token keyword">new</span> SparkContext<span class="token punctuation">(</span>conf<span class="token punctuation">)</span>
    <span class="token keyword">val</span> upcomingTrip<span class="token operator">:</span> Trip <span class="token operator">=</span> Trip<span class="token punctuation">(</span><span class="token string">"OTP"</span><span class="token punctuation">,</span> <span class="token string">"SFO"</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> lastWeekTrip<span class="token operator">:</span> Trip <span class="token operator">=</span> Trip<span class="token punctuation">(</span><span class="token string">"MUC"</span><span class="token punctuation">,</span> <span class="token string">"OTP"</span><span class="token punctuation">)</span>

    <span class="token keyword">val</span> rdd<span class="token operator">:</span> RDD<span class="token punctuation">[</span>Trip<span class="token punctuation">]</span> <span class="token operator">=</span> sc<span class="token punctuation">.</span>makeRDD<span class="token punctuation">(</span>Seq<span class="token punctuation">(</span>upcomingTrip<span class="token punctuation">,</span> lastWeekTrip<span class="token punctuation">)</span><span class="token punctuation">)</span>
    EsSpark<span class="token punctuation">.</span>saveToEs<span class="token punctuation">(</span>rdd<span class="token punctuation">,</span> <span class="token string">"spark/docs"</span><span class="token punctuation">,</span> Map<span class="token punctuation">(</span><span class="token string">"es.mapping.id"</span> <span class="token operator">-&gt;</span> <span class="token string">"id"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token comment">// define a case class</span>
<span class="token keyword">case</span> <span class="token keyword">class</span> Trip<span class="token punctuation">(</span>departure<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span> arrival<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="使用字符串json方式"><a href="#使用字符串json方式" class="headerlink" title="使用字符串json方式"></a>使用字符串json方式</h3><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">package</span> <span class="token namespace">org<span class="token punctuation">.</span>bigdata<span class="token punctuation">.</span>es</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span></span><span class="token punctuation">{</span>SparkConf<span class="token punctuation">,</span> SparkContext<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>spark<span class="token punctuation">.</span></span>_


<span class="token keyword">object</span> D03 <span class="token punctuation">{</span>
  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token keyword">val</span> conf<span class="token operator">:</span> SparkConf <span class="token operator">=</span> <span class="token keyword">new</span> SparkConf<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setAppName<span class="token punctuation">(</span><span class="token string">"d01"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setMaster<span class="token punctuation">(</span><span class="token string">"local[*]"</span><span class="token punctuation">)</span>
    conf<span class="token punctuation">.</span>set<span class="token punctuation">(</span><span class="token string">"es.index.auto.create"</span><span class="token punctuation">,</span> <span class="token string">"true"</span><span class="token punctuation">)</span>

    <span class="token keyword">val</span> sc<span class="token operator">:</span> SparkContext <span class="token operator">=</span> <span class="token keyword">new</span> SparkContext<span class="token punctuation">(</span>conf<span class="token punctuation">)</span>

    <span class="token keyword">val</span> json1 <span class="token operator">=</span> <span class="token triple-quoted-string string">"""{"reason" : "business", "airport" : "SFO"}"""</span>
    <span class="token keyword">val</span> json2 <span class="token operator">=</span> <span class="token triple-quoted-string string">"""{"participants" : 5, "airport" : "OTP"}"""</span>
    sc<span class="token punctuation">.</span>makeRDD<span class="token punctuation">(</span>Seq<span class="token punctuation">(</span>json1<span class="token punctuation">,</span> json2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>saveToEs<span class="token punctuation">(</span><span class="token string">"spark/json-trips"</span><span class="token punctuation">)</span>

  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="动态index"><a href="#动态index" class="headerlink" title="动态index"></a>动态index</h3><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">package</span> <span class="token namespace">org<span class="token punctuation">.</span>bigdata<span class="token punctuation">.</span>es</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span></span><span class="token punctuation">{</span>SparkConf<span class="token punctuation">,</span> SparkContext<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>spark<span class="token punctuation">.</span></span>_

<span class="token keyword">object</span> D04 <span class="token punctuation">{</span>
  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token keyword">val</span> conf<span class="token operator">:</span> SparkConf <span class="token operator">=</span> <span class="token keyword">new</span> SparkConf<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setAppName<span class="token punctuation">(</span><span class="token string">"d01"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setMaster<span class="token punctuation">(</span><span class="token string">"local[*]"</span><span class="token punctuation">)</span>
    conf<span class="token punctuation">.</span>set<span class="token punctuation">(</span><span class="token string">"es.index.auto.create"</span><span class="token punctuation">,</span> <span class="token string">"true"</span><span class="token punctuation">)</span>

    <span class="token keyword">val</span> sc<span class="token operator">:</span> SparkContext <span class="token operator">=</span> <span class="token keyword">new</span> SparkContext<span class="token punctuation">(</span>conf<span class="token punctuation">)</span>

    <span class="token keyword">val</span> game <span class="token operator">=</span> Map<span class="token punctuation">(</span>
      <span class="token string">"media_type"</span> <span class="token operator">-&gt;</span> <span class="token string">"game"</span><span class="token punctuation">,</span>
      <span class="token string">"title"</span> <span class="token operator">-&gt;</span> <span class="token string">"FF VI"</span><span class="token punctuation">,</span>
      <span class="token string">"year"</span> <span class="token operator">-&gt;</span> <span class="token string">"1994"</span><span class="token punctuation">)</span>

    <span class="token keyword">val</span> book <span class="token operator">=</span> Map<span class="token punctuation">(</span><span class="token string">"media_type"</span> <span class="token operator">-&gt;</span> <span class="token string">"book"</span><span class="token punctuation">,</span> <span class="token string">"title"</span> <span class="token operator">-&gt;</span> <span class="token string">"Harry Potter"</span><span class="token punctuation">,</span> <span class="token string">"year"</span> <span class="token operator">-&gt;</span> <span class="token string">"2010"</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> cd <span class="token operator">=</span> Map<span class="token punctuation">(</span><span class="token string">"media_type"</span> <span class="token operator">-&gt;</span> <span class="token string">"music"</span><span class="token punctuation">,</span> <span class="token string">"title"</span> <span class="token operator">-&gt;</span> <span class="token string">"Surfing With The Alien"</span><span class="token punctuation">)</span>

    sc<span class="token punctuation">.</span>makeRDD<span class="token punctuation">(</span>Seq<span class="token punctuation">(</span>game<span class="token punctuation">,</span> book<span class="token punctuation">,</span> cd<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>saveToEs<span class="token punctuation">(</span><span class="token string">"my-collection-{media_type}/doc"</span><span class="token punctuation">)</span>

  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      <categories>
        <category>大数据</category>
      </categories>
      <tags>
        <tag>spark</tag>
        <tag>es</tag>
        <tag>大数据</tag>
      </tags>
  </entry>
  <entry>
    <title>go爬虫框架colly源码以及软件架构分析</title>
    <url>/2021/08/01/colly/</url>
    <content><![CDATA[<p><img src="https://raw.githubusercontent.com/jacksonyoudi/images/main/uPic/6hvTNM.jpg"></p>
<p>无意中发现了<code>colly</code>,我一直是使用python进行爬虫的， 学习golang的使用， 用<code>go</code>参考<code>scrapy</code>架构写了一个爬虫的框架demo。我一直以为go不适合做爬虫， go的领域是后端服务。然后去搜索了一下<code>colly</code>, 发现还是很流行。 我个人还是比较喜欢爬虫， 网络上的数据就是公开的API， 所以， 爬虫去请求接口获取数据。当然我是遵循君子协议的。</p>
<p>好， 下面进入正题，介绍<code>colly</code></p>
<h3 id="colly介绍"><a href="#colly介绍" class="headerlink" title="colly介绍"></a>colly介绍</h3><p><code>Lightning Fast and Elegant Scraping Framework for Gophers</code></p>
<p><code>Colly provides a clean interface to write any kind of crawler/scraper/spider.</code><br>官方的介绍，gocolly快速优雅，在单核上每秒可以发起1K以上请求；以回调函数的形式提供了一组接口，可以实现任意类型的爬虫；依赖goquery库可以像jquery一样选择web元素。</p>
<h3 id="安装使用"><a href="#安装使用" class="headerlink" title="安装使用"></a>安装使用</h3><p><a href="https://github.com/gocolly/colly">colly</a><br><a href="http://go-colly.org/">官网</a></p>
<pre class="line-numbers language-none"><code class="language-none">go get -u github.com/gocolly/colly/...<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">import</span> <span class="token string">"github.com/gocolly/colly"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>



<h3 id="架构特点"><a href="#架构特点" class="headerlink" title="架构特点"></a>架构特点</h3><p>了解爬虫的都知道一个爬虫请求的生命周期</p>
<blockquote>
<ol>
<li>构建请求</li>
<li>发送请求</li>
<li>获取文档或数据</li>
<li>解析文档或清洗数据</li>
<li>数据处理或持久化</li>
</ol>
</blockquote>
<p>scrapy的设计理念是将上面的每一个步骤抽离出来，然后做出组件的形式， 最后通过调度组成流水线的工作形式。<br>我们看一下scrapy的架构图， 这里只是简单的介绍下， 后面有时间，我深入介绍scrapy<br><img src="https://raw.githubusercontent.com/jacksonyoudi/images/main/uPic/0kfy9f.jpg" alt="0kfy9f"></p>
<p>如图，<code>downloader</code>负责请求获取页面，<code>spiders</code>中写具体解析文档的逻辑，<code>item PipeLine</code>数据最后处理， 中间有一些中间件，可以一些功能的装饰。比如，代理，请求频率等。</p>
<p>我们介绍一下colly的架构特点<br>colly的逻辑更像是面向过程编程的， colly的逻辑就是按上面生命周期的顺序管道处理， 只是在不同阶段，加上回调函数进行过滤的时候进行处理。<br><img src="https://raw.githubusercontent.com/jacksonyoudi/images/main/uPic/IS4YSc.jpg"></p>
<p>下面也按照这个逻辑进行介绍</p>
<h3 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h3><p>先给一个🌰</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go">
<span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"fmt"</span>

	<span class="token string">"github.com/gocolly/colly"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// Instantiate default collector</span>
	c <span class="token operator">:=</span> colly<span class="token punctuation">.</span><span class="token function">NewCollector</span><span class="token punctuation">(</span>
		<span class="token comment">// Visit only domains: hackerspaces.org, wiki.hackerspaces.org</span>
		colly<span class="token punctuation">.</span><span class="token function">AllowedDomains</span><span class="token punctuation">(</span><span class="token string">"hackerspaces.org"</span><span class="token punctuation">,</span> <span class="token string">"wiki.hackerspaces.org"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">)</span>

	<span class="token comment">// On every a element which has href attribute call callback</span>
	c<span class="token punctuation">.</span><span class="token function">OnHTML</span><span class="token punctuation">(</span><span class="token string">"a[href]"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>e <span class="token operator">*</span>colly<span class="token punctuation">.</span>HTMLElement<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		link <span class="token operator">:=</span> e<span class="token punctuation">.</span><span class="token function">Attr</span><span class="token punctuation">(</span><span class="token string">"href"</span><span class="token punctuation">)</span>
		<span class="token comment">// Print link</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"Link found: %q -&gt; %s\n"</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span>Text<span class="token punctuation">,</span> link<span class="token punctuation">)</span>
		<span class="token comment">// Visit link found on page</span>
		<span class="token comment">// Only those links are visited which are in AllowedDomains</span>
		c<span class="token punctuation">.</span><span class="token function">Visit</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>Request<span class="token punctuation">.</span><span class="token function">AbsoluteURL</span><span class="token punctuation">(</span>link<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>

	<span class="token comment">// Before making a request print "Visiting ..."</span>
	c<span class="token punctuation">.</span><span class="token function">OnRequest</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>r <span class="token operator">*</span>colly<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Visiting"</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>URL<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>

	<span class="token comment">// Start scraping on https://hackerspaces.org</span>
	c<span class="token punctuation">.</span><span class="token function">Visit</span><span class="token punctuation">(</span><span class="token string">"https://hackerspaces.org/"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这是官方给的示例， 可以看到<code>colly.NewCollector</code>创建一个<code>收集器</code>， colly的所有处理逻辑都是以<code>Collector</code>为核心进行操作的。</p>
<p>我们看一下 <code>Collector</code>结构体的定义</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// Collector provides the scraper instance for a scraping job</span>
<span class="token keyword">type</span> Collector <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	<span class="token comment">// UserAgent is the User-Agent string used by HTTP requests</span>
	UserAgent <span class="token builtin">string</span>
	<span class="token comment">// MaxDepth limits the recursion depth of visited URLs.</span>
	<span class="token comment">// Set it to 0 for infinite recursion (default).</span>
	MaxDepth <span class="token builtin">int</span>
	<span class="token comment">// AllowedDomains is a domain whitelist.</span>
	<span class="token comment">// Leave it blank to allow any domains to be visited</span>
	AllowedDomains <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span>
	<span class="token comment">// DisallowedDomains is a domain blacklist.</span>
	DisallowedDomains <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span>
	<span class="token comment">// DisallowedURLFilters is a list of regular expressions which restricts</span>
	<span class="token comment">// visiting URLs. If any of the rules matches to a URL the</span>
	<span class="token comment">// request will be stopped. DisallowedURLFilters will</span>
	<span class="token comment">// be evaluated before URLFilters</span>
	<span class="token comment">// Leave it blank to allow any URLs to be visited</span>
	DisallowedURLFilters <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>regexp<span class="token punctuation">.</span>Regexp
	<span class="token comment">// URLFilters is a list of regular expressions which restricts</span>
	<span class="token comment">// visiting URLs. If any of the rules matches to a URL the</span>
	<span class="token comment">// request won't be stopped. DisallowedURLFilters will</span>
	<span class="token comment">// be evaluated before URLFilters</span>

	<span class="token comment">// Leave it blank to allow any URLs to be visited</span>
	URLFilters <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>regexp<span class="token punctuation">.</span>Regexp

	<span class="token comment">// AllowURLRevisit allows multiple downloads of the same URL</span>
	AllowURLRevisit <span class="token builtin">bool</span>
	<span class="token comment">// MaxBodySize is the limit of the retrieved response body in bytes.</span>
	<span class="token comment">// 0 means unlimited.</span>
	<span class="token comment">// The default value for MaxBodySize is 10MB (10 * 1024 * 1024 bytes).</span>
	MaxBodySize <span class="token builtin">int</span>
	<span class="token comment">// CacheDir specifies a location where GET requests are cached as files.</span>
	<span class="token comment">// When it's not defined, caching is disabled.</span>
	CacheDir <span class="token builtin">string</span>
	<span class="token comment">// IgnoreRobotsTxt allows the Collector to ignore any restrictions set by</span>
	<span class="token comment">// the target host's robots.txt file.  See http://www.robotstxt.org/ for more</span>
	<span class="token comment">// information.</span>
	IgnoreRobotsTxt <span class="token builtin">bool</span>
	<span class="token comment">// Async turns on asynchronous network communication. Use Collector.Wait() to</span>
	<span class="token comment">// be sure all requests have been finished.</span>
	Async <span class="token builtin">bool</span>
	<span class="token comment">// ParseHTTPErrorResponse allows parsing HTTP responses with non 2xx status codes.</span>
	<span class="token comment">// By default, Colly parses only successful HTTP responses. Set ParseHTTPErrorResponse</span>
	<span class="token comment">// to true to enable it.</span>
	ParseHTTPErrorResponse <span class="token builtin">bool</span>
	<span class="token comment">// ID is the unique identifier of a collector</span>
	ID <span class="token builtin">uint32</span>
	<span class="token comment">// DetectCharset can enable character encoding detection for non-utf8 response bodies</span>
	<span class="token comment">// without explicit charset declaration. This feature uses https://github.com/saintfish/chardet</span>
	DetectCharset <span class="token builtin">bool</span>
	<span class="token comment">// RedirectHandler allows control on how a redirect will be managed</span>
	RedirectHandler <span class="token keyword">func</span><span class="token punctuation">(</span>req <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">,</span> via <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token builtin">error</span>
	<span class="token comment">// CheckHead performs a HEAD request before every GET to pre-validate the response</span>
	CheckHead         <span class="token builtin">bool</span>
	store             storage<span class="token punctuation">.</span>Storage
	debugger          debug<span class="token punctuation">.</span>Debugger
	robotsMap         <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>robotstxt<span class="token punctuation">.</span>RobotsData
	htmlCallbacks     <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>htmlCallbackContainer
	xmlCallbacks      <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>xmlCallbackContainer
	requestCallbacks  <span class="token punctuation">[</span><span class="token punctuation">]</span>RequestCallback
	responseCallbacks <span class="token punctuation">[</span><span class="token punctuation">]</span>ResponseCallback
	errorCallbacks    <span class="token punctuation">[</span><span class="token punctuation">]</span>ErrorCallback
	scrapedCallbacks  <span class="token punctuation">[</span><span class="token punctuation">]</span>ScrapedCallback
	requestCount      <span class="token builtin">uint32</span>
	responseCount     <span class="token builtin">uint32</span>
	backend           <span class="token operator">*</span>httpBackend
	wg                <span class="token operator">*</span>sync<span class="token punctuation">.</span>WaitGroup
	lock              <span class="token operator">*</span>sync<span class="token punctuation">.</span>RWMutex
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>上面的具体属性我就不介绍了， 看看注释也就懂了。<br>我就先按上面的示例解释源码</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">   // 创建一个 Collector对象
c :<span class="token operator">=</span> colly.NewCollector<span class="token punctuation">(</span>
	// Visit only domains: hackerspaces.org, wiki.hackerspaces.org
	colly.AllowedDomains<span class="token punctuation">(</span><span class="token string">"hackerspaces.org"</span>, <span class="token string">"wiki.hackerspaces.org"</span><span class="token punctuation">)</span>,
<span class="token punctuation">)</span>

// 添加一个HTML的回调函数
c.OnHTML<span class="token punctuation">(</span><span class="token string">"a[href]"</span>, func<span class="token punctuation">(</span>e *colly.HTMLElement<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">link</span> :<span class="token operator">=</span> e.Attr<span class="token punctuation">(</span><span class="token string">"href"</span><span class="token punctuation">)</span>
	// Print <span class="token function">link</span>
	fmt.Printf<span class="token punctuation">(</span><span class="token string">"Link found: %q -&gt; %s<span class="token entity" title="\n">\n</span>"</span>, e.Text, <span class="token function">link</span><span class="token punctuation">)</span>
	// Visit <span class="token function">link</span> found on page
	// Only those links are visited <span class="token function">which</span> are <span class="token keyword">in</span> AllowedDomains
	c.Visit<span class="token punctuation">(</span>e.Request.AbsoluteURL<span class="token punctuation">(</span>link<span class="token punctuation">))</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

// 添加一个 Requset回调函数
c.OnRequest<span class="token punctuation">(</span>func<span class="token punctuation">(</span>r *colly.Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt.Println<span class="token punctuation">(</span><span class="token string">"Visiting"</span>, r.URL.String<span class="token punctuation">(</span><span class="token punctuation">))</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

// 开始爬取
c.Visit<span class="token punctuation">(</span><span class="token string">"https://hackerspaces.org/"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>回调函数如何用？ 什么作用？ 先卖个关子， <code>c.Visit("https://hackerspaces.org/")</code>是入口， 那就先分析它，</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// Visit starts Collector's collecting job by creating a</span>
<span class="token comment">// request to the URL specified in parameter.</span>
<span class="token comment">// Visit also calls the previously provided callbacks</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Collector<span class="token punctuation">)</span> <span class="token function">Visit</span><span class="token punctuation">(</span>URL <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> c<span class="token punctuation">.</span>CheckHead <span class="token punctuation">{</span>
		<span class="token keyword">if</span> check <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">scrape</span><span class="token punctuation">(</span>URL<span class="token punctuation">,</span> <span class="token string">"HEAD"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> check <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> check
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> c<span class="token punctuation">.</span><span class="token function">scrape</span><span class="token punctuation">(</span>URL<span class="token punctuation">,</span> <span class="token string">"GET"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>👆又出来一个新的method，</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Collector<span class="token punctuation">)</span> <span class="token function">scrape</span><span class="token punctuation">(</span>u<span class="token punctuation">,</span> method <span class="token builtin">string</span><span class="token punctuation">,</span> depth <span class="token builtin">int</span><span class="token punctuation">,</span> requestData io<span class="token punctuation">.</span>Reader<span class="token punctuation">,</span> ctx <span class="token operator">*</span>Context<span class="token punctuation">,</span> hdr http<span class="token punctuation">.</span>Header<span class="token punctuation">,</span> checkRevisit <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    <span class="token comment">// 检查请求是否合法</span>
	<span class="token keyword">if</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">requestCheck</span><span class="token punctuation">(</span>u<span class="token punctuation">,</span> method<span class="token punctuation">,</span> depth<span class="token punctuation">,</span> checkRevisit<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">}</span>
    <span class="token comment">// 解析url，</span>
	parsedURL<span class="token punctuation">,</span> err <span class="token operator">:=</span> url<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span>u<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> parsedURL<span class="token punctuation">.</span>Scheme <span class="token operator">==</span> <span class="token string">""</span> <span class="token punctuation">{</span>
		parsedURL<span class="token punctuation">.</span>Scheme <span class="token operator">=</span> <span class="token string">"http"</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>c<span class="token punctuation">.</span><span class="token function">isDomainAllowed</span><span class="token punctuation">(</span>parsedURL<span class="token punctuation">.</span><span class="token function">Hostname</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> ErrForbiddenDomain
	<span class="token punctuation">}</span>
    <span class="token comment">// robots协议</span>
	<span class="token keyword">if</span> method <span class="token operator">!=</span> <span class="token string">"HEAD"</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>c<span class="token punctuation">.</span>IgnoreRobotsTxt <span class="token punctuation">{</span>
		<span class="token keyword">if</span> err <span class="token operator">=</span> c<span class="token punctuation">.</span><span class="token function">checkRobots</span><span class="token punctuation">(</span>parsedURL<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> err
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
     <span class="token comment">// headers</span>
	<span class="token keyword">if</span> hdr <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		hdr <span class="token operator">=</span> http<span class="token punctuation">.</span>Header<span class="token punctuation">{</span><span class="token string">"User-Agent"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span>c<span class="token punctuation">.</span>UserAgent<span class="token punctuation">}</span><span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	rc<span class="token punctuation">,</span> ok <span class="token operator">:=</span> requestData<span class="token punctuation">.</span><span class="token punctuation">(</span>io<span class="token punctuation">.</span>ReadCloser<span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token operator">&amp;&amp;</span> requestData <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		rc <span class="token operator">=</span> ioutil<span class="token punctuation">.</span><span class="token function">NopCloser</span><span class="token punctuation">(</span>requestData<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// The Go HTTP API ignores "Host" in the headers, preferring the client</span>
	<span class="token comment">// to use the Host field on Request.</span>
	host <span class="token operator">:=</span> parsedURL<span class="token punctuation">.</span>Host
	<span class="token keyword">if</span> hostHeader <span class="token operator">:=</span> hdr<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">"Host"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> hostHeader <span class="token operator">!=</span> <span class="token string">""</span> <span class="token punctuation">{</span>
		host <span class="token operator">=</span> hostHeader
	<span class="token punctuation">}</span>
    <span class="token comment">// 构造http.Request</span>
	req <span class="token operator">:=</span> <span class="token operator">&amp;</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">{</span>
		Method<span class="token punctuation">:</span>     method<span class="token punctuation">,</span>
		URL<span class="token punctuation">:</span>        parsedURL<span class="token punctuation">,</span>
		Proto<span class="token punctuation">:</span>      <span class="token string">"HTTP/1.1"</span><span class="token punctuation">,</span>
		ProtoMajor<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
		ProtoMinor<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
		Header<span class="token punctuation">:</span>     hdr<span class="token punctuation">,</span>
		Body<span class="token punctuation">:</span>       rc<span class="token punctuation">,</span>
		Host<span class="token punctuation">:</span>       host<span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
    <span class="token comment">// 请求的数据（requestData）转换成io.ReadCloser接口数据</span>
	<span class="token function">setRequestBody</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> requestData<span class="token punctuation">)</span>
	u <span class="token operator">=</span> parsedURL<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	c<span class="token punctuation">.</span>wg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token comment">// 异步方式</span>
	<span class="token keyword">if</span> c<span class="token punctuation">.</span>Async <span class="token punctuation">{</span>
		<span class="token keyword">go</span> c<span class="token punctuation">.</span><span class="token function">fetch</span><span class="token punctuation">(</span>u<span class="token punctuation">,</span> method<span class="token punctuation">,</span> depth<span class="token punctuation">,</span> requestData<span class="token punctuation">,</span> ctx<span class="token punctuation">,</span> hdr<span class="token punctuation">,</span> req<span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> c<span class="token punctuation">.</span><span class="token function">fetch</span><span class="token punctuation">(</span>u<span class="token punctuation">,</span> method<span class="token punctuation">,</span> depth<span class="token punctuation">,</span> requestData<span class="token punctuation">,</span> ctx<span class="token punctuation">,</span> hdr<span class="token punctuation">,</span> req<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>上面很大篇幅都是检查， 现在还在 <code>request</code>的阶段， 还没有response，看<code>c.fetch</code></p>
<p>fetch就是colly的核心内容</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Collector<span class="token punctuation">)</span> <span class="token function">fetch</span><span class="token punctuation">(</span>u<span class="token punctuation">,</span> method <span class="token builtin">string</span><span class="token punctuation">,</span> depth <span class="token builtin">int</span><span class="token punctuation">,</span> requestData io<span class="token punctuation">.</span>Reader<span class="token punctuation">,</span> ctx <span class="token operator">*</span>Context<span class="token punctuation">,</span> hdr http<span class="token punctuation">.</span>Header<span class="token punctuation">,</span> req <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	<span class="token keyword">defer</span> c<span class="token punctuation">.</span>wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> ctx <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		ctx <span class="token operator">=</span> <span class="token function">NewContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	request <span class="token operator">:=</span> <span class="token operator">&amp;</span>Request<span class="token punctuation">{</span>
		URL<span class="token punctuation">:</span>       req<span class="token punctuation">.</span>URL<span class="token punctuation">,</span>
		Headers<span class="token punctuation">:</span>   <span class="token operator">&amp;</span>req<span class="token punctuation">.</span>Header<span class="token punctuation">,</span>
		Ctx<span class="token punctuation">:</span>       ctx<span class="token punctuation">,</span>
		Depth<span class="token punctuation">:</span>     depth<span class="token punctuation">,</span>
		Method<span class="token punctuation">:</span>    method<span class="token punctuation">,</span>
		Body<span class="token punctuation">:</span>      requestData<span class="token punctuation">,</span>
		collector<span class="token punctuation">:</span> c<span class="token punctuation">,</span> <span class="token comment">// 这里将Collector放到request中，这个可以对请求继续处理</span>
		ID<span class="token punctuation">:</span>        atomic<span class="token punctuation">.</span><span class="token function">AddUint32</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c<span class="token punctuation">.</span>requestCount<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
    <span class="token comment">// 回调函数处理 request</span>
	c<span class="token punctuation">.</span><span class="token function">handleOnRequest</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span>

	<span class="token keyword">if</span> request<span class="token punctuation">.</span>abort <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> method <span class="token operator">==</span> <span class="token string">"POST"</span> <span class="token operator">&amp;&amp;</span> req<span class="token punctuation">.</span>Header<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">"Content-Type"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">""</span> <span class="token punctuation">{</span>
		req<span class="token punctuation">.</span>Header<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token string">"Content-Type"</span><span class="token punctuation">,</span> <span class="token string">"application/x-www-form-urlencoded"</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> req<span class="token punctuation">.</span>Header<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">"Accept"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">""</span> <span class="token punctuation">{</span>
		req<span class="token punctuation">.</span>Header<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">"Accept"</span><span class="token punctuation">,</span> <span class="token string">"*/*"</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	origURL <span class="token operator">:=</span> req<span class="token punctuation">.</span>URL
    <span class="token comment">// 这里是 去请求网络， 是调用了 `http.Client.Do`方法请求的</span>
	response<span class="token punctuation">,</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span>backend<span class="token punctuation">.</span><span class="token function">Cache</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> c<span class="token punctuation">.</span>MaxBodySize<span class="token punctuation">,</span> c<span class="token punctuation">.</span>CacheDir<span class="token punctuation">)</span>
	<span class="token keyword">if</span> proxyURL<span class="token punctuation">,</span> ok <span class="token operator">:=</span> req<span class="token punctuation">.</span><span class="token function">Context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Value</span><span class="token punctuation">(</span>ProxyURLKey<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
		request<span class="token punctuation">.</span>ProxyURL <span class="token operator">=</span> proxyURL
	<span class="token punctuation">}</span>
    <span class="token comment">// 回调函数，处理error</span>
	<span class="token keyword">if</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">handleOnError</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> err<span class="token punctuation">,</span> request<span class="token punctuation">,</span> ctx<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> req<span class="token punctuation">.</span>URL <span class="token operator">!=</span> origURL <span class="token punctuation">{</span>
		request<span class="token punctuation">.</span>URL <span class="token operator">=</span> req<span class="token punctuation">.</span>URL
		request<span class="token punctuation">.</span>Headers <span class="token operator">=</span> <span class="token operator">&amp;</span>req<span class="token punctuation">.</span>Header
	<span class="token punctuation">}</span>
	atomic<span class="token punctuation">.</span><span class="token function">AddUint32</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c<span class="token punctuation">.</span>responseCount<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
	response<span class="token punctuation">.</span>Ctx <span class="token operator">=</span> ctx
	response<span class="token punctuation">.</span>Request <span class="token operator">=</span> request

	err <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">fixCharset</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>DetectCharset<span class="token punctuation">,</span> request<span class="token punctuation">.</span>ResponseCharacterEncoding<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">}</span>
    <span class="token comment">// 回调函数 处理Response</span>
	c<span class="token punctuation">.</span><span class="token function">handleOnResponse</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span>
    
    <span class="token comment">// 回调函数 HTML</span>
	err <span class="token operator">=</span> c<span class="token punctuation">.</span><span class="token function">handleOnHTML</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		c<span class="token punctuation">.</span><span class="token function">handleOnError</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> err<span class="token punctuation">,</span> request<span class="token punctuation">,</span> ctx<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
    <span class="token comment">// 回调函数XML</span>
	err <span class="token operator">=</span> c<span class="token punctuation">.</span><span class="token function">handleOnXML</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		c<span class="token punctuation">.</span><span class="token function">handleOnError</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> err<span class="token punctuation">,</span> request<span class="token punctuation">,</span> ctx<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
    <span class="token comment">// 回调函数 Scraped</span>
	c<span class="token punctuation">.</span><span class="token function">handleOnScraped</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span>

	<span class="token keyword">return</span> err
<span class="token punctuation">}</span>

<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>看到了， 这就是一个完整的流程。 好， 我们看一下回调函数做了什么？</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Collector<span class="token punctuation">)</span> <span class="token function">handleOnRequest</span><span class="token punctuation">(</span>r <span class="token operator">*</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> c<span class="token punctuation">.</span>debugger <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		c<span class="token punctuation">.</span>debugger<span class="token punctuation">.</span><span class="token function">Event</span><span class="token punctuation">(</span><span class="token function">createEvent</span><span class="token punctuation">(</span><span class="token string">"request"</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>ID<span class="token punctuation">,</span> c<span class="token punctuation">.</span>ID<span class="token punctuation">,</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span>
			<span class="token string">"url"</span><span class="token punctuation">:</span> r<span class="token punctuation">.</span>URL<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> f <span class="token operator">:=</span> <span class="token keyword">range</span> c<span class="token punctuation">.</span>requestCallbacks <span class="token punctuation">{</span>
		<span class="token function">f</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>核心就 <code>for _, f := range c.requestCallbacks { f(r) }</code>这句，下面我每个回调函数都介绍一下</p>
<h3 id="回调函数"><a href="#回调函数" class="headerlink" title="回调函数"></a>回调函数</h3><p>这里介绍按生命周期的顺序来介绍</p>
<h4 id="1-OnRequest"><a href="#1-OnRequest" class="headerlink" title="1. OnRequest"></a>1. OnRequest</h4> <pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// OnRequest registers a function. Function will be executed on every</span>
<span class="token comment">// request made by the Collector</span>
<span class="token comment">// 这里是注册回调函数到 requestCallbacks</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Collector<span class="token punctuation">)</span> <span class="token function">OnRequest</span><span class="token punctuation">(</span>f RequestCallback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	c<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> c<span class="token punctuation">.</span>requestCallbacks <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		c<span class="token punctuation">.</span>requestCallbacks <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>RequestCallback<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	c<span class="token punctuation">.</span>requestCallbacks <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>requestCallbacks<span class="token punctuation">,</span> f<span class="token punctuation">)</span>
	c<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>


<span class="token comment">// 在fetch中调用最早调用的</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Collector<span class="token punctuation">)</span> <span class="token function">handleOnRequest</span><span class="token punctuation">(</span>r <span class="token operator">*</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> c<span class="token punctuation">.</span>debugger <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		c<span class="token punctuation">.</span>debugger<span class="token punctuation">.</span><span class="token function">Event</span><span class="token punctuation">(</span><span class="token function">createEvent</span><span class="token punctuation">(</span><span class="token string">"request"</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>ID<span class="token punctuation">,</span> c<span class="token punctuation">.</span>ID<span class="token punctuation">,</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span>
			<span class="token string">"url"</span><span class="token punctuation">:</span> r<span class="token punctuation">.</span>URL<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> f <span class="token operator">:=</span> <span class="token keyword">range</span> c<span class="token punctuation">.</span>requestCallbacks <span class="token punctuation">{</span>
		<span class="token function">f</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<h4 id="2-OnResponse-amp-handleOnResponse"><a href="#2-OnResponse-amp-handleOnResponse" class="headerlink" title="2. OnResponse &amp; handleOnResponse"></a>2. OnResponse &amp; handleOnResponse</h4><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// OnResponse registers a function. Function will be executed on every response</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Collector<span class="token punctuation">)</span> <span class="token function">OnResponse</span><span class="token punctuation">(</span>f ResponseCallback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	c<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> c<span class="token punctuation">.</span>responseCallbacks <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		c<span class="token punctuation">.</span>responseCallbacks <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>ResponseCallback<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	c<span class="token punctuation">.</span>responseCallbacks <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>responseCallbacks<span class="token punctuation">,</span> f<span class="token punctuation">)</span>
	c<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>


<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Collector<span class="token punctuation">)</span> <span class="token function">handleOnResponse</span><span class="token punctuation">(</span>r <span class="token operator">*</span>Response<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> c<span class="token punctuation">.</span>debugger <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		c<span class="token punctuation">.</span>debugger<span class="token punctuation">.</span><span class="token function">Event</span><span class="token punctuation">(</span><span class="token function">createEvent</span><span class="token punctuation">(</span><span class="token string">"response"</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>ID<span class="token punctuation">,</span> c<span class="token punctuation">.</span>ID<span class="token punctuation">,</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span>
			<span class="token string">"url"</span><span class="token punctuation">:</span>    r<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>URL<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
			<span class="token string">"status"</span><span class="token punctuation">:</span> http<span class="token punctuation">.</span><span class="token function">StatusText</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>StatusCode<span class="token punctuation">)</span><span class="token punctuation">,</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> f <span class="token operator">:=</span> <span class="token keyword">range</span> c<span class="token punctuation">.</span>responseCallbacks <span class="token punctuation">{</span>
		<span class="token function">f</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<h4 id="3-OnHTML-amp-handleOnHTML"><a href="#3-OnHTML-amp-handleOnHTML" class="headerlink" title="3. OnHTML &amp; handleOnHTML"></a>3. OnHTML &amp; handleOnHTML</h4><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// OnHTML registers a function. Function will be executed on every HTML</span>
<span class="token comment">// element matched by the GoQuery Selector parameter.</span>
<span class="token comment">// GoQuery Selector is a selector used by https://github.com/PuerkitoBio/goquery</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Collector<span class="token punctuation">)</span> <span class="token function">OnHTML</span><span class="token punctuation">(</span>goquerySelector <span class="token builtin">string</span><span class="token punctuation">,</span> f HTMLCallback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	c<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> c<span class="token punctuation">.</span>htmlCallbacks <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		c<span class="token punctuation">.</span>htmlCallbacks <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>htmlCallbackContainer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	c<span class="token punctuation">.</span>htmlCallbacks <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>htmlCallbacks<span class="token punctuation">,</span> <span class="token operator">&amp;</span>htmlCallbackContainer<span class="token punctuation">{</span>
		Selector<span class="token punctuation">:</span> goquerySelector<span class="token punctuation">,</span>
		Function<span class="token punctuation">:</span> f<span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
	c<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 这个解析html的逻辑比较多一些</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Collector<span class="token punctuation">)</span> <span class="token function">handleOnHTML</span><span class="token punctuation">(</span>resp <span class="token operator">*</span>Response<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>htmlCallbacks<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token operator">!</span>strings<span class="token punctuation">.</span><span class="token function">Contains</span><span class="token punctuation">(</span>strings<span class="token punctuation">.</span><span class="token function">ToLower</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span>Headers<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">"Content-Type"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"html"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span>
	<span class="token punctuation">}</span>
	doc<span class="token punctuation">,</span> err <span class="token operator">:=</span> goquery<span class="token punctuation">.</span><span class="token function">NewDocumentFromReader</span><span class="token punctuation">(</span>bytes<span class="token punctuation">.</span><span class="token function">NewBuffer</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span>Body<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> href<span class="token punctuation">,</span> found <span class="token operator">:=</span> doc<span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token string">"base[href]"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Attr</span><span class="token punctuation">(</span><span class="token string">"href"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> found <span class="token punctuation">{</span>
		resp<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>baseURL<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span>href<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> cc <span class="token operator">:=</span> <span class="token keyword">range</span> c<span class="token punctuation">.</span>htmlCallbacks <span class="token punctuation">{</span>
		i <span class="token operator">:=</span> <span class="token number">0</span>
		doc<span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span>cc<span class="token punctuation">.</span>Selector<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Each</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span><span class="token boolean">_</span> <span class="token builtin">int</span><span class="token punctuation">,</span> s <span class="token operator">*</span>goquery<span class="token punctuation">.</span>Selection<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> n <span class="token operator">:=</span> <span class="token keyword">range</span> s<span class="token punctuation">.</span>Nodes <span class="token punctuation">{</span>
				e <span class="token operator">:=</span> <span class="token function">NewHTMLElementFromSelectionNode</span><span class="token punctuation">(</span>resp<span class="token punctuation">,</span> s<span class="token punctuation">,</span> n<span class="token punctuation">,</span> i<span class="token punctuation">)</span>
				i<span class="token operator">++</span>
				<span class="token keyword">if</span> c<span class="token punctuation">.</span>debugger <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
					c<span class="token punctuation">.</span>debugger<span class="token punctuation">.</span><span class="token function">Event</span><span class="token punctuation">(</span><span class="token function">createEvent</span><span class="token punctuation">(</span><span class="token string">"html"</span><span class="token punctuation">,</span> resp<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>ID<span class="token punctuation">,</span> c<span class="token punctuation">.</span>ID<span class="token punctuation">,</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span>
						<span class="token string">"selector"</span><span class="token punctuation">:</span> cc<span class="token punctuation">.</span>Selector<span class="token punctuation">,</span>
						<span class="token string">"url"</span><span class="token punctuation">:</span>      resp<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>URL<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
					<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
				<span class="token punctuation">}</span>
				cc<span class="token punctuation">.</span><span class="token function">Function</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="4-OnXML-amp-handleOnXML"><a href="#4-OnXML-amp-handleOnXML" class="headerlink" title="4. OnXML &amp; handleOnXML"></a>4. OnXML &amp; handleOnXML</h4><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// OnXML registers a function. Function will be executed on every XML</span>
<span class="token comment">// element matched by the xpath Query parameter.</span>
<span class="token comment">// xpath Query is used by https://github.com/antchfx/xmlquery</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Collector<span class="token punctuation">)</span> <span class="token function">OnXML</span><span class="token punctuation">(</span>xpathQuery <span class="token builtin">string</span><span class="token punctuation">,</span> f XMLCallback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	c<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> c<span class="token punctuation">.</span>xmlCallbacks <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		c<span class="token punctuation">.</span>xmlCallbacks <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>xmlCallbackContainer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	c<span class="token punctuation">.</span>xmlCallbacks <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>xmlCallbacks<span class="token punctuation">,</span> <span class="token operator">&amp;</span>xmlCallbackContainer<span class="token punctuation">{</span>
		Query<span class="token punctuation">:</span>    xpathQuery<span class="token punctuation">,</span>
		Function<span class="token punctuation">:</span> f<span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
	c<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>



<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Collector<span class="token punctuation">)</span> <span class="token function">handleOnXML</span><span class="token punctuation">(</span>resp <span class="token operator">*</span>Response<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>xmlCallbacks<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span>
	<span class="token punctuation">}</span>
	contentType <span class="token operator">:=</span> strings<span class="token punctuation">.</span><span class="token function">ToLower</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span>Headers<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">"Content-Type"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	isXMLFile <span class="token operator">:=</span> strings<span class="token punctuation">.</span><span class="token function">HasSuffix</span><span class="token punctuation">(</span>strings<span class="token punctuation">.</span><span class="token function">ToLower</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>Path<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">".xml"</span><span class="token punctuation">)</span> <span class="token operator">||</span> strings<span class="token punctuation">.</span><span class="token function">HasSuffix</span><span class="token punctuation">(</span>strings<span class="token punctuation">.</span><span class="token function">ToLower</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>Path<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">".xml.gz"</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>strings<span class="token punctuation">.</span><span class="token function">Contains</span><span class="token punctuation">(</span>contentType<span class="token punctuation">,</span> <span class="token string">"html"</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token operator">!</span>strings<span class="token punctuation">.</span><span class="token function">Contains</span><span class="token punctuation">(</span>contentType<span class="token punctuation">,</span> <span class="token string">"xml"</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>isXMLFile<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> strings<span class="token punctuation">.</span><span class="token function">Contains</span><span class="token punctuation">(</span>contentType<span class="token punctuation">,</span> <span class="token string">"html"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		doc<span class="token punctuation">,</span> err <span class="token operator">:=</span> htmlquery<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span>bytes<span class="token punctuation">.</span><span class="token function">NewBuffer</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span>Body<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> err
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> e <span class="token operator">:=</span> htmlquery<span class="token punctuation">.</span><span class="token function">FindOne</span><span class="token punctuation">(</span>doc<span class="token punctuation">,</span> <span class="token string">"//base"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> e <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> a <span class="token operator">:=</span> <span class="token keyword">range</span> e<span class="token punctuation">.</span>Attr <span class="token punctuation">{</span>
				<span class="token keyword">if</span> a<span class="token punctuation">.</span>Key <span class="token operator">==</span> <span class="token string">"href"</span> <span class="token punctuation">{</span>
					resp<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>baseURL<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>Val<span class="token punctuation">)</span>
					<span class="token keyword">break</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>

		<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> cc <span class="token operator">:=</span> <span class="token keyword">range</span> c<span class="token punctuation">.</span>xmlCallbacks <span class="token punctuation">{</span>
			<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> n <span class="token operator">:=</span> <span class="token keyword">range</span> htmlquery<span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span>doc<span class="token punctuation">,</span> cc<span class="token punctuation">.</span>Query<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				e <span class="token operator">:=</span> <span class="token function">NewXMLElementFromHTMLNode</span><span class="token punctuation">(</span>resp<span class="token punctuation">,</span> n<span class="token punctuation">)</span>
				<span class="token keyword">if</span> c<span class="token punctuation">.</span>debugger <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
					c<span class="token punctuation">.</span>debugger<span class="token punctuation">.</span><span class="token function">Event</span><span class="token punctuation">(</span><span class="token function">createEvent</span><span class="token punctuation">(</span><span class="token string">"xml"</span><span class="token punctuation">,</span> resp<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>ID<span class="token punctuation">,</span> c<span class="token punctuation">.</span>ID<span class="token punctuation">,</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span>
						<span class="token string">"selector"</span><span class="token punctuation">:</span> cc<span class="token punctuation">.</span>Query<span class="token punctuation">,</span>
						<span class="token string">"url"</span><span class="token punctuation">:</span>      resp<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>URL<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
					<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
				<span class="token punctuation">}</span>
				cc<span class="token punctuation">.</span><span class="token function">Function</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> strings<span class="token punctuation">.</span><span class="token function">Contains</span><span class="token punctuation">(</span>contentType<span class="token punctuation">,</span> <span class="token string">"xml"</span><span class="token punctuation">)</span> <span class="token operator">||</span> isXMLFile <span class="token punctuation">{</span>
		doc<span class="token punctuation">,</span> err <span class="token operator">:=</span> xmlquery<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span>bytes<span class="token punctuation">.</span><span class="token function">NewBuffer</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span>Body<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> err
		<span class="token punctuation">}</span>

		<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> cc <span class="token operator">:=</span> <span class="token keyword">range</span> c<span class="token punctuation">.</span>xmlCallbacks <span class="token punctuation">{</span>
			xmlquery<span class="token punctuation">.</span><span class="token function">FindEach</span><span class="token punctuation">(</span>doc<span class="token punctuation">,</span> cc<span class="token punctuation">.</span>Query<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>i <span class="token builtin">int</span><span class="token punctuation">,</span> n <span class="token operator">*</span>xmlquery<span class="token punctuation">.</span>Node<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				e <span class="token operator">:=</span> <span class="token function">NewXMLElementFromXMLNode</span><span class="token punctuation">(</span>resp<span class="token punctuation">,</span> n<span class="token punctuation">)</span>
				<span class="token keyword">if</span> c<span class="token punctuation">.</span>debugger <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
					c<span class="token punctuation">.</span>debugger<span class="token punctuation">.</span><span class="token function">Event</span><span class="token punctuation">(</span><span class="token function">createEvent</span><span class="token punctuation">(</span><span class="token string">"xml"</span><span class="token punctuation">,</span> resp<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>ID<span class="token punctuation">,</span> c<span class="token punctuation">.</span>ID<span class="token punctuation">,</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span>
						<span class="token string">"selector"</span><span class="token punctuation">:</span> cc<span class="token punctuation">.</span>Query<span class="token punctuation">,</span>
						<span class="token string">"url"</span><span class="token punctuation">:</span>      resp<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>URL<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
					<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
				<span class="token punctuation">}</span>
				cc<span class="token punctuation">.</span><span class="token function">Function</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
			<span class="token punctuation">}</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>


<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<h4 id="5-OnError-amp-handleOnError"><a href="#5-OnError-amp-handleOnError" class="headerlink" title="5. OnError &amp; handleOnError"></a>5. OnError &amp; handleOnError</h4><p>这个会多次调用， 如果 <code>err != nil情况下调用比较多</code>， 爬虫异常的情况下，会调用</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// OnError registers a function. Function will be executed if an error</span>
<span class="token comment">// occurs during the HTTP request.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Collector<span class="token punctuation">)</span> <span class="token function">OnError</span><span class="token punctuation">(</span>f ErrorCallback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	c<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> c<span class="token punctuation">.</span>errorCallbacks <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		c<span class="token punctuation">.</span>errorCallbacks <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>ErrorCallback<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	c<span class="token punctuation">.</span>errorCallbacks <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>errorCallbacks<span class="token punctuation">,</span> f<span class="token punctuation">)</span>
	c<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>


<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Collector<span class="token punctuation">)</span> <span class="token function">handleOnError</span><span class="token punctuation">(</span>response <span class="token operator">*</span>Response<span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">,</span> request <span class="token operator">*</span>Request<span class="token punctuation">,</span> ctx <span class="token operator">*</span>Context<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>c<span class="token punctuation">.</span>ParseHTTPErrorResponse <span class="token operator">||</span> response<span class="token punctuation">.</span>StatusCode <span class="token operator">&lt;</span> <span class="token number">203</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> response<span class="token punctuation">.</span>StatusCode <span class="token operator">&gt;=</span> <span class="token number">203</span> <span class="token punctuation">{</span>
		err <span class="token operator">=</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span><span class="token function">StatusText</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>StatusCode<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> response <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		response <span class="token operator">=</span> <span class="token operator">&amp;</span>Response<span class="token punctuation">{</span>
			Request<span class="token punctuation">:</span> request<span class="token punctuation">,</span>
			Ctx<span class="token punctuation">:</span>     ctx<span class="token punctuation">,</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> c<span class="token punctuation">.</span>debugger <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		c<span class="token punctuation">.</span>debugger<span class="token punctuation">.</span><span class="token function">Event</span><span class="token punctuation">(</span><span class="token function">createEvent</span><span class="token punctuation">(</span><span class="token string">"error"</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span>ID<span class="token punctuation">,</span> c<span class="token punctuation">.</span>ID<span class="token punctuation">,</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span>
			<span class="token string">"url"</span><span class="token punctuation">:</span>    request<span class="token punctuation">.</span>URL<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
			<span class="token string">"status"</span><span class="token punctuation">:</span> http<span class="token punctuation">.</span><span class="token function">StatusText</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>StatusCode<span class="token punctuation">)</span><span class="token punctuation">,</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> response<span class="token punctuation">.</span>Request <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		response<span class="token punctuation">.</span>Request <span class="token operator">=</span> request
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> response<span class="token punctuation">.</span>Ctx <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		response<span class="token punctuation">.</span>Ctx <span class="token operator">=</span> request<span class="token punctuation">.</span>Ctx
	<span class="token punctuation">}</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> f <span class="token operator">:=</span> <span class="token keyword">range</span> c<span class="token punctuation">.</span>errorCallbacks <span class="token punctuation">{</span>
		<span class="token function">f</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> err
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="6-OnScraped-amp-handleOnScraped"><a href="#6-OnScraped-amp-handleOnScraped" class="headerlink" title="6. OnScraped &amp; handleOnScraped"></a>6. OnScraped &amp; handleOnScraped</h4><p>最后一步的回调函数处理</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// OnScraped registers a function. Function will be executed after</span>
<span class="token comment">// OnHTML, as a final part of the scraping.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Collector<span class="token punctuation">)</span> <span class="token function">OnScraped</span><span class="token punctuation">(</span>f ScrapedCallback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	c<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> c<span class="token punctuation">.</span>scrapedCallbacks <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		c<span class="token punctuation">.</span>scrapedCallbacks <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>ScrapedCallback<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	c<span class="token punctuation">.</span>scrapedCallbacks <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>scrapedCallbacks<span class="token punctuation">,</span> f<span class="token punctuation">)</span>
	c<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Collector<span class="token punctuation">)</span> <span class="token function">handleOnScraped</span><span class="token punctuation">(</span>r <span class="token operator">*</span>Response<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> c<span class="token punctuation">.</span>debugger <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		c<span class="token punctuation">.</span>debugger<span class="token punctuation">.</span><span class="token function">Event</span><span class="token punctuation">(</span><span class="token function">createEvent</span><span class="token punctuation">(</span><span class="token string">"scraped"</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>ID<span class="token punctuation">,</span> c<span class="token punctuation">.</span>ID<span class="token punctuation">,</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span>
			<span class="token string">"url"</span><span class="token punctuation">:</span> r<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>URL<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> f <span class="token operator">:=</span> <span class="token keyword">range</span> c<span class="token punctuation">.</span>scrapedCallbacks <span class="token punctuation">{</span>
		<span class="token function">f</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>注册回调函数的method还有几个没有列出来，感兴趣的，自己看一下，</p>
<p>上面介绍完了， 再回头看🌰</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// On every a element which has href attribute call callback</span>
c<span class="token punctuation">.</span><span class="token function">OnHTML</span><span class="token punctuation">(</span><span class="token string">"a[href]"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>e <span class="token operator">*</span>colly<span class="token punctuation">.</span>HTMLElement<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	link <span class="token operator">:=</span> e<span class="token punctuation">.</span><span class="token function">Attr</span><span class="token punctuation">(</span><span class="token string">"href"</span><span class="token punctuation">)</span>
	<span class="token comment">// Print link</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"Link found: %q -&gt; %s\n"</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span>Text<span class="token punctuation">,</span> link<span class="token punctuation">)</span>
	<span class="token comment">// Visit link found on page</span>
	<span class="token comment">// Only those links are visited which are in AllowedDomains</span>
	c<span class="token punctuation">.</span><span class="token function">Visit</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>Request<span class="token punctuation">.</span><span class="token function">AbsoluteURL</span><span class="token punctuation">(</span>link<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// Before making a request print "Visiting ..."</span>
c<span class="token punctuation">.</span><span class="token function">OnRequest</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>r <span class="token operator">*</span>colly<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Visiting"</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>URL<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>一般文档解析放在html, xml 中</p>
<h3 id="页面跳转爬取"><a href="#页面跳转爬取" class="headerlink" title="页面跳转爬取"></a>页面跳转爬取</h3><p>一般处理就2种，一种是相同逻辑的页面，比如<code>下一页</code>，另一种，就是不同逻辑的，比如<code>子页面</code></p>
<ol>
<li>在<code>html</code>,<code>xml</code>，解析出来以后，构建新的请求，我们看一下，相同页面<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// On every a element which has href attribute call callback</span>
c<span class="token punctuation">.</span><span class="token function">OnHTML</span><span class="token punctuation">(</span><span class="token string">"a[href]"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>e <span class="token operator">*</span>colly<span class="token punctuation">.</span>HTMLElement<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// If attribute class is this long string return from callback</span>
	<span class="token comment">// As this a is irrelevant</span>
	<span class="token keyword">if</span> e<span class="token punctuation">.</span><span class="token function">Attr</span><span class="token punctuation">(</span><span class="token string">"class"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"Button_1qxkboh-o_O-primary_cv02ee-o_O-md_28awn8-o_O-primaryLink_109aggg"</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	link <span class="token operator">:=</span> e<span class="token punctuation">.</span><span class="token function">Attr</span><span class="token punctuation">(</span><span class="token string">"href"</span><span class="token punctuation">)</span>
	<span class="token comment">// If link start with browse or includes either signup or login return from callback</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>strings<span class="token punctuation">.</span><span class="token function">HasPrefix</span><span class="token punctuation">(</span>link<span class="token punctuation">,</span> <span class="token string">"/browse"</span><span class="token punctuation">)</span> <span class="token operator">||</span> strings<span class="token punctuation">.</span><span class="token function">Index</span><span class="token punctuation">(</span>link<span class="token punctuation">,</span> <span class="token string">"=signup"</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">||</span> strings<span class="token punctuation">.</span><span class="token function">Index</span><span class="token punctuation">(</span>link<span class="token punctuation">,</span> <span class="token string">"=login"</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// start scaping the page under the link found</span>
	e<span class="token punctuation">.</span>Request<span class="token punctuation">.</span><span class="token function">Visit</span><span class="token punctuation">(</span>link<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
上面是 HTML的回调函数，解析页面，获取了<code>url</code>,使用 <code>e.Request.Visit(link)</code>, 其实就是 <code>e.Request.collector.Visit(link)</code><br>我解释一下<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Collector<span class="token punctuation">)</span> <span class="token function">fetch</span><span class="token punctuation">(</span>u<span class="token punctuation">,</span> method <span class="token builtin">string</span><span class="token punctuation">,</span> depth <span class="token builtin">int</span><span class="token punctuation">,</span> requestData io<span class="token punctuation">.</span>Reader<span class="token punctuation">,</span> ctx <span class="token operator">*</span>Context<span class="token punctuation">,</span> hdr http<span class="token punctuation">.</span>Header<span class="token punctuation">,</span> req <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	<span class="token keyword">defer</span> c<span class="token punctuation">.</span>wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> ctx <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		ctx <span class="token operator">=</span> <span class="token function">NewContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	request <span class="token operator">:=</span> <span class="token operator">&amp;</span>Request<span class="token punctuation">{</span>
		URL<span class="token punctuation">:</span>       req<span class="token punctuation">.</span>URL<span class="token punctuation">,</span>
		Headers<span class="token punctuation">:</span>   <span class="token operator">&amp;</span>req<span class="token punctuation">.</span>Header<span class="token punctuation">,</span>
		Ctx<span class="token punctuation">:</span>       ctx<span class="token punctuation">,</span>
		Depth<span class="token punctuation">:</span>     depth<span class="token punctuation">,</span>
		Method<span class="token punctuation">:</span>    method<span class="token punctuation">,</span>
		Body<span class="token punctuation">:</span>      requestData<span class="token punctuation">,</span>
		collector<span class="token punctuation">:</span> c<span class="token punctuation">,</span> <span class="token comment">// 这个上面有介绍</span>
		ID<span class="token punctuation">:</span>        atomic<span class="token punctuation">.</span><span class="token function">AddUint32</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c<span class="token punctuation">.</span>requestCount<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
    <span class="token operator">...</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span><span class="token punctuation">}</span>


<span class="token comment">// Visit continues Collector's collecting job by creating a</span>
<span class="token comment">// request and preserves the Context of the previous request.</span>
<span class="token comment">// Visit also calls the previously provided callbacks</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>Request<span class="token punctuation">)</span> <span class="token function">Visit</span><span class="token punctuation">(</span>URL <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> r<span class="token punctuation">.</span>collector<span class="token punctuation">.</span><span class="token function">scrape</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span><span class="token function">AbsoluteURL</span><span class="token punctuation">(</span>URL<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"GET"</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>Depth<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>Ctx<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
这种方法在实际开发中经常会用到。</li>
</ol>
<ol start="2">
<li>子页面的处理逻辑<br>colly中主要是以<code>Collector</code>为中心， 然后各种回调函数进行处理，子页面需要不同的回调函数，所以就需要新的 <code>Collector</code></li>
</ol>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// Instantiate default collector</span>
c <span class="token operator">:=</span> colly<span class="token punctuation">.</span><span class="token function">NewCollector</span><span class="token punctuation">(</span>
	<span class="token comment">// Visit only domains: coursera.org, www.coursera.org</span>
	colly<span class="token punctuation">.</span><span class="token function">AllowedDomains</span><span class="token punctuation">(</span><span class="token string">"coursera.org"</span><span class="token punctuation">,</span> <span class="token string">"www.coursera.org"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

	<span class="token comment">// Cache responses to prevent multiple download of pages</span>
	<span class="token comment">// even if the collector is restarted</span>
	colly<span class="token punctuation">.</span><span class="token function">CacheDir</span><span class="token punctuation">(</span><span class="token string">"./coursera_cache"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>

<span class="token comment">// Create another collector to scrape course details</span>
detailCollector <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">Clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// Before making a request print "Visiting ..."</span>
c<span class="token punctuation">.</span><span class="token function">OnRequest</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>r <span class="token operator">*</span>colly<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"visiting"</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>URL<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// On every a HTML element which has name attribute call callback</span>
c<span class="token punctuation">.</span><span class="token function">OnHTML</span><span class="token punctuation">(</span><span class="token string">`a[name]`</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>e <span class="token operator">*</span>colly<span class="token punctuation">.</span>HTMLElement<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// Activate detailCollector if the link contains "coursera.org/learn"</span>
	courseURL <span class="token operator">:=</span> e<span class="token punctuation">.</span>Request<span class="token punctuation">.</span><span class="token function">AbsoluteURL</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">Attr</span><span class="token punctuation">(</span><span class="token string">"href"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> strings<span class="token punctuation">.</span><span class="token function">Index</span><span class="token punctuation">(</span>courseURL<span class="token punctuation">,</span> <span class="token string">"coursera.org/learn"</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">{</span>
          <span class="token comment">// 子页面或其他页面</span>
		detailCollector<span class="token punctuation">.</span><span class="token function">Visit</span><span class="token punctuation">(</span>courseURL<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<h3 id="持久化"><a href="#持久化" class="headerlink" title="持久化"></a>持久化</h3><p><code>Collector</code>对象有一个属性 <code>store             storage.Storage</code>是存储的，这个是将数据直接存储下来，没有清洗。<br>比如， 我需要将数据持久化到数据库中，其实很简单， 在回调函数中处理。</p>
<p>给个例子</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go">c<span class="token punctuation">.</span><span class="token function">OnHTML</span><span class="token punctuation">(</span><span class="token string">"#currencies-all tbody tr"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>e <span class="token operator">*</span>colly<span class="token punctuation">.</span>HTMLElement<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	mysql<span class="token punctuation">.</span><span class="token function">WriteObjectStrings</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span>
		e<span class="token punctuation">.</span><span class="token function">ChildText</span><span class="token punctuation">(</span><span class="token string">".currency-name-container"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		e<span class="token punctuation">.</span><span class="token function">ChildText</span><span class="token punctuation">(</span><span class="token string">".col-symbol"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		e<span class="token punctuation">.</span><span class="token function">ChildAttr</span><span class="token punctuation">(</span><span class="token string">"a.price"</span><span class="token punctuation">,</span> <span class="token string">"data-usd"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		e<span class="token punctuation">.</span><span class="token function">ChildAttr</span><span class="token punctuation">(</span><span class="token string">"a.volume"</span><span class="token punctuation">,</span> <span class="token string">"data-usd"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		e<span class="token punctuation">.</span><span class="token function">ChildAttr</span><span class="token punctuation">(</span><span class="token string">".market-cap"</span><span class="token punctuation">,</span> <span class="token string">"data-usd"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		e<span class="token punctuation">.</span><span class="token function">ChildAttr</span><span class="token punctuation">(</span><span class="token string">".percent-change[data-timespan=\"1h\"]"</span><span class="token punctuation">,</span> <span class="token string">"data-percentusd"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		e<span class="token punctuation">.</span><span class="token function">ChildAttr</span><span class="token punctuation">(</span><span class="token string">".percent-change[data-timespan=\"24h\"]"</span><span class="token punctuation">,</span> <span class="token string">"data-percentusd"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		e<span class="token punctuation">.</span><span class="token function">ChildAttr</span><span class="token punctuation">(</span><span class="token string">".percent-change[data-timespan=\"7d\"]"</span><span class="token punctuation">,</span> <span class="token string">"data-percentusd"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>好了，介绍完了，我没有介绍如何使用，我自己也没有写任何的代码， 我只想分享给你这种软件架构的特点以及设计模式， 希望你可以借鉴应用到工作中，一般写框架都是采用这种思维。<br>下面这张图很形象，爬虫框架就这些东西。<br><img src="https://raw.githubusercontent.com/jacksonyoudi/images/main/uPic/BqC7ix.jpg" alt="通用爬虫框架架构"></p>
]]></content>
      <categories>
        <category>技术</category>
      </categories>
      <tags>
        <tag>crawler</tag>
        <tag>爬虫</tag>
        <tag>go</tag>
        <tag>colly</tag>
      </tags>
  </entry>
  <entry>
    <title>项目管理工具maven</title>
    <url>/2021/08/01/maven/</url>
    <content><![CDATA[<p>在学习的技术越来越多，写的代码越来越多，会发现代码管理越来越复杂，就自然有了包的概念。我个人前面的jar包都是手动管理的，由于，我经常使用python的pip以及golang的 govender以及 gomods，所以，会想到java的包管理工具，查了一下，发现maven很强大，可以极大的提高开发效率，故学习，下面是学习过程中整理的笔记。</p>
<h2 id="目前在技术开发中存在的问题"><a href="#目前在技术开发中存在的问题" class="headerlink" title="目前在技术开发中存在的问题"></a>目前在技术开发中存在的问题</h2><ol>
<li><p>一个项目就是一个工程<br>如果项目非常庞大，就不适合继续使用package来划分模块。最好是每一个模块对应一个项目，利于分工协作。<br>借助于maven就可以将一个项目拆分成多个工程。</p>
</li>
<li><p>项目中需要的jar包必须手动“复制”、”粘贴” 到WEB-INF/lib 项目下<br>带来的问题：同样的jar包文件重复出现在不同的项目工程中，一方面浪费存储空间，另外也让工程比较臃肿。<br>借助Maven，可以将jar包仅仅保存在“仓库”中，有需要使用的工程“引用”这个文件，并不需要重复复制。</p>
</li>
<li><p>jar包需要别人替我们准备好，或到官网下载<br>所有知名框架或第三方工具jar包已经按照统一规范放在了Maven的中央仓库中。</p>
</li>
<li><p>一个jar包依赖的其他jar包需要自己手动加到项目中<br>Maven会自动将被依赖的jar包导入进来。</p>
</li>
</ol>
<h2 id="maven是什么"><a href="#maven是什么" class="headerlink" title="maven是什么"></a>maven是什么</h2><ol>
<li>Maven 是 Apache 软件基金会组织维护的一款自动化构建工具，专注服务于 Java 平台的项目构建和依赖管理 。Maven 这个单词的本意是：专家，内行。读音是[‘meɪv(ə)n]或[‘mevn]。<br>构建工具的发展：Make→Ant→Maven→Gradle</li>
</ol>
<ol start="2">
<li>构建：就是以我们编写的Java代码、框架配置文件、国际化等其他资源文件、jsp页面和图片等静态资源作为“原材料”，去“生产”出一个可以运行的项目的过程。<br>理想的项目构建：高度自动化，跨平台，可重用的组件，标准化的</li>
</ol>
<p>3.构建过程中的几个主要环节<br>①清理：删除以前的编译结果，为重新编译做好准备。<br>②编译：将Java源程序编译为字节码文件。<br>③测试：针对项目中的关键点进行测试，确保项目在迭代开发过程中关键点的正确性。<br>④报告：将每一次测试后以标准的格式记录和展示测试结果。<br>⑤打包：将一个包含诸多文件的工程封装为一个压缩文件用于安装或部署。Java工程对应jar包，Web工程对象war包。<br>⑥安装：在Maven环境下特指将打包的结果——Jar包或War包安装到本地仓库中。<br>⑦部署：将打包的结果部署到远程仓库或将war包部署到服务器上运行。</p>
<p><img src="https://raw.githubusercontent.com/jacksonyoudi/images/main/uPic/PeaY9R.jpg"></p>
<p>日常开发中，如果不通过maven，以上步骤全部是程序员自己手动一个一个的去编译执行操作，有了maven， 只需要简单的一个命令，全部搞定，解放双手。</p>
<ol start="4">
<li>什么是依赖？为什么要进行依赖管理？<br>依赖是Maven中最关键的部分，我们之所以在工程中使用Maven，就是因为它的依赖管理功能。<br>自动下载，统一依赖管理，避免jar包引起的错误。</li>
</ol>
<h3 id="maven安装"><a href="#maven安装" class="headerlink" title="maven安装"></a>maven安装</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">brew <span class="token function">install</span> maven<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>安装完成后，查看安装文件</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">
macbookpro <span class="token operator">&gt;</span> brew list maven
/usr/local/Cellar/maven/3.6.1/bin/mvn
/usr/local/Cellar/maven/3.6.1/bin/mvnDebug
/usr/local/Cellar/maven/3.6.1/bin/mvnyjp
/usr/local/Cellar/maven/3.6.1/libexec/bin/ <span class="token punctuation">(</span><span class="token number">4</span> files<span class="token punctuation">)</span>
/usr/local/Cellar/maven/3.6.1/libexec/boot/plexus-classworlds-2.6.0.jar
/usr/local/Cellar/maven/3.6.1/libexec/conf/ <span class="token punctuation">(</span><span class="token number">3</span> files<span class="token punctuation">)</span>
/usr/local/Cellar/maven/3.6.1/libexec/lib/ <span class="token punctuation">(</span><span class="token number">63</span> files<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>测试一下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">macbookpro<span class="token operator">&gt;</span> mvn --v
Apache Maven <span class="token number">3.6</span>.1 <span class="token punctuation">(</span>d66c9c0b3152b2e69ee9bac180bb8fcc8e6af555<span class="token punctuation">;</span> <span class="token number">2019</span>-04-05T03:00:29+08:00<span class="token punctuation">)</span>
Maven home: /usr/local/Cellar/maven/3.6.1/libexec
Java version: <span class="token number">1.8</span>.0_172, vendor: Oracle Corporation, runtime: /Library/Java/JavaVirtualMachines/jdk1.8.0_172.jdk/Contents/Home/jre
Default locale: zh_CN, platform encoding: UTF-8
OS name: <span class="token string">"mac os x"</span>, version: <span class="token string">"10.15"</span>, arch: <span class="token string">"x86_64"</span>, family: <span class="token string">"mac"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>可以使用<code>mvn --help</code>查看帮助</p>
<h3 id="maven的核心概念"><a href="#maven的核心概念" class="headerlink" title="maven的核心概念"></a>maven的核心概念</h3><blockquote>
<p>约定的目录结构<br>POM<br>坐标<br>依赖<br>仓库<br>生命周期/插件/目标<br>继承<br>聚合</p>
</blockquote>
<p>以下内容就是按上面进行展开的</p>
<h4 id="使用idea创建一个maven工程"><a href="#使用idea创建一个maven工程" class="headerlink" title="使用idea创建一个maven工程"></a>使用idea创建一个maven工程</h4><ol>
<li><p>idea支持创建maven项目<br><img src="https://raw.githubusercontent.com/jacksonyoudi/images/main/uPic/NFqnYK.jpg"></p>
<p><img src="https://raw.githubusercontent.com/jacksonyoudi/images/main/uPic/Oo9fzo.jpg"></p>
<p><img src="https://raw.githubusercontent.com/jacksonyoudi/images/main/uPic/ZhCzDy.jpg"></p>
<p><img src="https://raw.githubusercontent.com/jacksonyoudi/images/main/uPic/C70JLZ.jpg"></p>
</li>
</ol>
<p>pom.xml文件为Maven工程的核心配置文件</p>
<ol start="2">
<li>为什么要遵循约定的目录结构呢？<br>我们在开发中如果需要让第三方工具或框架知道我们自己创建的资源在哪，那么基本上就是两种方式：<br>①以配置文件的方式明确告诉框架 如 &lt; param-value&gt;classpath:spring-context.xml &lt; /param-value&gt;<br>②遵循框架内部已经存在的约定 如log4j的配置文件名规定必须为 log4j.properties 或 log4j.xml ；Maven 使用约定的目录结构</li>
</ol>
<h4 id="maven常用命令"><a href="#maven常用命令" class="headerlink" title="maven常用命令"></a>maven常用命令</h4><ol>
<li>注意：执行与构建过程相关的Maven命令，必须进入pom.xml 所在的目录。</li>
<li>常用命令<blockquote>
<p>mvn clean : 清理<br>mvn compile : 编译主程序<br>mvn test-compile : 编译测试程序<br>mvn test : 执行测试<br>mvn package : 打包<br>mvn install ： 安装<br>mvn site ：生成站点</p>
</blockquote>
</li>
</ol>
<h4 id="maven网络问题"><a href="#maven网络问题" class="headerlink" title="maven网络问题"></a>maven网络问题</h4><ol>
<li>Maven 的核心程序中仅仅定义了抽象的生命周期，但是具体的工作必须有特定的插件来完成。而插件本身不包含在Maven核心程序中。</li>
<li>当我们执行的Maven命令需要用到某些插件时，Maven核心程序会首先到本地仓库中查找。</li>
<li>本地仓库的默认位置：~/.m2/repository</li>
<li>Maven核心程序如果在本地仓库中找不到需要的插件，那么它会自动连接外网，到中央仓库下载。</li>
<li>如果此时无法连接外网，则构建失败。</li>
<li>修改默认本地仓库的位置可以让Maven核心程序到我们事先准备好的目录下查找插件<br>①找到Maven解压目录\conf\settings.xml<br>②在setting.xml 文件中找到 localRepository 标签<br>③将 &lt; localRepository&gt;/path/to/local/repo&lt; /localRepository&gt;从注释中取出<br>④将标签体内容修改为自定义的Maven仓库目录</li>
</ol>
<p>如果网络慢，也可以配置阿里的国内镜像。</p>
<h2 id="POM"><a href="#POM" class="headerlink" title="POM"></a>POM</h2><ol>
<li><p>含义：Project Object Model 项目对象模型<br>DOM ：Document Object Model 文档对象模型</p>
</li>
<li><p>pom.xml 对于 Maven工程是核心配置文件，与构建过程相关的一切设置都在这个文件中进行配置。<br>重要程度相当于web.xml 对于动态web工程</p>
</li>
</ol>
<p>POM 中可以指定以下配置：</p>
<blockquote>
<p>项目依赖<br>插件<br>执行目标<br>项目构建 profile<br>项目版本<br>项目开发者列表<br>相关邮件列表信息</p>
</blockquote>
<p>示例：</p>
<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>project</span> <span class="token attr-name">xmlns</span> <span class="token attr-value"><span class="token punctuation attr-equals">=</span> <span class="token punctuation">"</span>http://maven.apache.org/POM/4.0.0<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span> <span class="token attr-value"><span class="token punctuation attr-equals">=</span> <span class="token punctuation">"</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span> <span class="token attr-value"><span class="token punctuation attr-equals">=</span> <span class="token punctuation">"</span>http://maven.apache.org/POM/4.0.0
    http://maven.apache.org/xsd/maven-4.0.0.xsd<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
 
    <span class="token comment">&lt;!-- 模型版本 --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>modelVersion</span><span class="token punctuation">&gt;</span></span>4.0.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>modelVersion</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- 公司或者组织的唯一标志，并且配置时生成的路径也是由此生成， 如com.companyname.project-group，maven会将该项目打成的jar包放本地路径：/com/companyname/project-group --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.companyname.project-group<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
 
    <span class="token comment">&lt;!-- 项目的唯一ID，一个groupId下面可能多个项目，就是靠artifactId来区分的 --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>project<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
 
    <span class="token comment">&lt;!-- 版本号 --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>project</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>所有 POM 文件都需要 project 元素和三个必需字段：groupId，artifactId，version。也就是下面需要说的 坐标</p>
<h3 id="坐标"><a href="#坐标" class="headerlink" title="坐标"></a>坐标</h3><p>坐标就是用来定位的</p>
<p>Maven的坐标：<br>使用下面三个向量在仓库中唯一定位一个Maven工程<br>①groupid:公司或组织域名倒序+项目名<br><code>&lt;groupId&gt;com.jackson.youdi&lt;/groupId&gt;</code><br>②artifactid:模块名<br><code>&lt;artifactId&gt;TheOne&lt;/artifactId&gt;</code><br>③version：版本<br><code>&lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;</code></p>
<ol start="3">
<li>Maven 工程的坐标与仓库中路径的对应关系,下面给两个例子<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml">&lt; groupId&gt;org.springframework&lt; /groupId&gt;
&lt; artifactId&gt;spring-core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
&lt; version&gt;4.0.0.RELEASE&lt; /version&gt;

org/springframework/spring-core/4.0.0.RELEASE/spring-core-4.0.0.RELEASE.jar

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>mysql<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>mysql-connector-java<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>8.0.18<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>

mysql/mysql-connector-java/8.0.18/mysql-connector-java-8.0.18.jar
绝对路径： ~/.m2/repository/mysql/mysql-connector-java/8.0.18/mysql-connector-java-8.0.18.jar<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ol>
<p>注意：我们自己的 Maven 工程必须执行安装操作才会进入仓库。安装的命令是：mvn install</p>
<h3 id="仓库"><a href="#仓库" class="headerlink" title="仓库"></a>仓库</h3><ol>
<li><p>仓库的分类<br>①本地仓库：当前电脑上部署的仓库目录，为当前电脑上所有Maven工程服务<br>②远程仓库<br>（1）私服：搭建在局域网环境中，为局域网范围内的所有Maven工程服务<br>（2）中央仓库：假设在Internet上，为全世界所有Maven工程服务<br>（3）中央仓库镜像：为了分担中央仓库流量，提升用户访问速度</p>
</li>
<li><p>仓库中保存的内容：Maven工程<br>①Maven自身所需要的插件<br>②第三方框架或工具的jar包<br>③我们自己开发的Maven工程</p>
</li>
</ol>
<p>不管是什么样的 jar 包，在仓库中都是按照坐标生成目录结构，所以可以通过统一的方式查询或依赖。</p>
<p><img src="https://raw.githubusercontent.com/jacksonyoudi/images/main/uPic/i512Gx.jpg"></p>
<h3 id="依赖"><a href="#依赖" class="headerlink" title="依赖"></a>依赖</h3><ol>
<li>当 A jar 包用到了 B jar 包中的某些类时，A 就对 B 产生了依赖，这是概念上的描述。Maven解析依赖信息时会到仓库中查找被依赖的jar包。<br>对于我们自己开发的Maven工程，要使用mvn install 命令安装后就可以进入仓库。</li>
</ol>
<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token comment">&lt;!--    dependecies 项目运行时的jar包--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- https://mvnrepository.com/artifact/mysql/mysql-connector-java --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>mysql<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>mysql-connector-java<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>8.0.18<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ol start="2">
<li>依赖的范围<br>①从项目结构角度理解compile和test的区别</li>
</ol>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">.</span>
├── main
│   ├── java  // compile范围依赖
│   └── resources
└── <span class="token builtin class-name">test</span>
    └── java  //  test范围依赖<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>compile范围依赖<br>》对主程序是否有效：有效<br>》对测试程序是否有效：有效<br>》是否参与打包：参与<br>》是否参与部署：参与<br>》典型例子：spring-core</p>
<p>test范围依赖<br>》对主程序是否有效：无效<br>》对测试程序是否有效：有效<br>》是否参与打包：不参与<br>》是否参与部署：不参与<br>》典型例子：Junit</p>
<p>②从开发和运行这两个阶段理解compile 和 provided 的区别</p>
<p><img src="https://raw.githubusercontent.com/jacksonyoudi/images/main/uPic/R1yMAr.jpg"></p>
<p>》对主程序是否有效：有效<br>》对测试程序是否有效：有效<br>》是否参与打包：不参与<br>》是否参与部署：不参与<br>》典型例子：Servlet-api.jar</p>
<p>③有效性总结</p>
<table>
<thead>
<tr>
<th></th>
<th>compile</th>
<th>test</th>
<th>provided</th>
</tr>
</thead>
<tbody><tr>
<td>主程序</td>
<td>√</td>
<td>x</td>
<td>√</td>
</tr>
<tr>
<td>测试程序</td>
<td>√</td>
<td>√</td>
<td>√</td>
</tr>
<tr>
<td>参与部署</td>
<td>√</td>
<td>x</td>
<td>x</td>
</tr>
</tbody></table>
<ol start="3">
<li>依赖的传递性<br>一种相当常见的情况，比如说 A 依赖于其他库 B。如果，另外一个项目 C 想要使用 A ，那么 C 项目也需要使用库 B。<br>Maven 可以避免去搜索所有所需库的需求。Maven 通过读取项目文件（pom.xml），找出它们项目之间的依赖关系。<br>我们需要做的只是在每个项目的 pom 中定义好直接的依赖关系。其他的事情 Maven 会帮我们搞定。<br>通过可传递性的依赖，所有被包含的库的图形会快速的增长。当有重复库时，可能出现的情形将会持续上升。Maven 提供一些功能来控制可传递的依赖的程度。</li>
</ol>
<h3 id="生命周期"><a href="#生命周期" class="headerlink" title="生命周期"></a>生命周期</h3><p><img src="https://raw.githubusercontent.com/jacksonyoudi/images/main/uPic/Ljs75u.jpg"></p>
<p>各个构建环节执行的顺序：不能打乱顺序，必须按照既定的正确顺序来执行。<br>Maven的核心程序中定义了抽象的生命周期，生命周期中各个阶段的具体任务是由插件来完成的。<br>Maven核心程序为了更好的实现自动化构建，按照这一特点执行生命周期中各个阶段：不论现在要执行生命周期中的哪一阶段，都是从这个生命周期最初的位置开始执行。<br>Maven有三套相互独立的生命周期，分别是：</p>
<h4 id="生命周期-1"><a href="#生命周期-1" class="headerlink" title="生命周期"></a>生命周期</h4><p>①Clean Lifecycle 在进行真正的构建之前进行一些清理工作。<br>②Default Lifecycle 构建的核心部分，编译、测试、打包、安装、部署等等。<br>③Site Lifecycle 生成项目报告，站点，发布站点。</p>
<p>他们相互独立。也可以直接运行 mvn clean install site 运行所有这三套生命周期。</p>
<p>每套生命周期都由一组阶段(Phase)组成，我们平时在命令行输入的命令总会对应于一个特定的阶段。比如，运行 mvn clean，这个 clean 是 Clean 生命周期的一个阶段。有 Clean 生命周期，也有 clean 阶段。</p>
<h4 id="Clean声明周期"><a href="#Clean声明周期" class="headerlink" title="Clean声明周期"></a>Clean声明周期</h4><p>①pre-clean 执行一些需要在clean之前完成的工作<br>②clean 移除所有上一次构建生成的文件<br>③post-clean 执行一些需要在clean 之后立刻完成的工作</p>
<h4 id="Default声明周期"><a href="#Default声明周期" class="headerlink" title="Default声明周期"></a>Default声明周期</h4><p>Default 生命周期是 Maven 生命周期中最重要的一个，绝大部分工作都发生在这个生命周期中。这里，只解释一些比较重要和常用的阶段：</p>
<blockquote>
<p>validate<br>generate-sources<br>process-sources<br>generate-resources<br>process-resources 复制并处理资源文件，至目标目录，准备打包。<br>compile 编译项目的源代码。<br>process-classes<br>generate-test-sources<br>process-test-sources<br>generate-test-resources<br>process-test-resources 复制并处理资源文件，至目标测试目录。<br>test-compile 编译测试源代码。<br>process-test-classes<br>test 使用合适的单元测试框架运行测试。这些测试代码不会被打包或部署。<br>prepare-package<br>package 接受编译好的代码，打包成可发布的格式，如 JAR。<br>pre-integration-test<br>integration-test<br>post-integration-test<br>verify<br>install 将包安装至本地仓库，以让其它项目依赖。<br>deploy 将最终的包复制到远程的仓库，以让其它开发人员与项目共享或部署到服务器上运行。</p>
</blockquote>
<h4 id="Site生命周期"><a href="#Site生命周期" class="headerlink" title="Site生命周期"></a>Site生命周期</h4><p>①pre-site 执行一些需要在生成站点文档之前完成的工作<br>②site 生成项目的站点文档<br>③post-site 执行一些需要在生成站点文档之后完成的工作，并且为部署做准备<br>④site-deploy 将生成的站点文档部署到特定的服务器上</p>
<p>这里经常用到的是 site 阶段和 site-deploy 阶段，用以生成和发布 Maven 站点，这可是 Maven 相当强大的功能，Manager 比较喜欢，文档及统计数据自动生成，很好看。</p>
<h4 id="插件和目标"><a href="#插件和目标" class="headerlink" title="插件和目标"></a>插件和目标</h4><p>Maven的核心仅仅定义了抽象的声明周期，具体的任务都是交由插件完成的。<br>每个插件都实现多个功能，每个功能就是一个插件目标<br>Maven的生命周期与插件目标相互绑定，以完成某个具体的构建任务。<br>可以将目标看做“调用插件功能的命令”</p>
<p>例如：compile 就是插件 maven-compiler-plugin 的一个目标；pre-clean 是插件 maven-clean-plugin 的一个目标。</p>
<p>以上内容来源于网络，推荐给大家比较好的资源： <a href="https://www.runoob.com/maven/maven-tutorial.html">https://www.runoob.com/maven/maven-tutorial.html</a></p>
]]></content>
      <categories>
        <category>工具软件</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>package manager</tag>
        <tag>maven</tag>
      </tags>
  </entry>
</search>
